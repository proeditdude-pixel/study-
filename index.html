<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="SyllabusStudy Enterprise Edition v3.0">
    
    <title>SyllabusStudy Ultimate</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* ==========================================================================
           1. ROOT VARIABLES & THEME ENGINE
           ========================================================================== */
        :root {
            /* Brand Colors */
            --primary-h: 212;
            --primary-s: 100%;
            --primary-l: 50%;
            --primary: hsl(var(--primary-h), var(--primary-s), var(--primary-l));
            --primary-dim: hsla(var(--primary-h), var(--primary-s), var(--primary-l), 0.15);
            --primary-glow: hsla(var(--primary-h), var(--primary-s), var(--primary-l), 0.4);

            /* Semantic Colors */
            --danger: #FF453A;
            --danger-bg: rgba(255, 69, 58, 0.1);
            --success: #32D74B;
            --success-bg: rgba(50, 215, 75, 0.1);
            --warning: #FFD60A;
            --warning-bg: rgba(255, 214, 10, 0.1);

            /* Backgrounds */
            --bg-body: #000000;
            --bg-surface: #1C1C1E;
            --bg-surface-2: #2C2C2E;
            --bg-glass: rgba(28, 28, 30, 0.85);
            --bg-input: #2C2C2E;
            
            /* Typography */
            --text-main: #FFFFFF;
            --text-sec: rgba(235, 235, 245, 0.6);
            --text-ter: rgba(235, 235, 245, 0.3);
            
            /* UI Metrics */
            --radius-xl: 32px;
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 8px;
            --border: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.2);
            
            /* Animation */
            --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
            --ease-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --duration-fast: 0.2s;
            --duration-norm: 0.4s;
            
            /* Layout */
            --dock-height: 80px;
            --header-height: 60px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* ==========================================================================
           2. RESET & BASE STYLES
           ========================================================================== */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevent body scroll, handle in views */
            font-size: 16px;
            line-height: 1.5;
        }

        /* ==========================================================================
           3. BACKGROUND & ATMOSPHERE
           ========================================================================== */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 0% 0%, #1a1a2e 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, #16213e 0%, transparent 50%);
            opacity: 0.6;
            pointer-events: none;
        }
        
        .ambient-orb {
            position: fixed;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: var(--primary);
            filter: blur(120px);
            opacity: 0.15;
            z-index: -1;
            animation: orbFloat 20s infinite ease-in-out alternate;
        }
        @keyframes orbFloat {
            0% { transform: translate(10vw, 10vh); }
            100% { transform: translate(60vw, 60vh); }
        }

        /* ==========================================================================
           4. TYPOGRAPHY SYSTEM
           ========================================================================== */
        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 700; letter-spacing: -0.02em; }
        h1 { font-size: 32px; margin-bottom: 8px; }
        h2 { font-size: 24px; margin-bottom: 6px; }
        h3 { font-size: 20px; margin-bottom: 4px; }
        p { color: var(--text-sec); font-size: 15px; margin: 0; }
        small { color: var(--text-ter); font-size: 13px; }
        b { color: var(--text-main); font-weight: 600; }

        .text-gradient {
            background: linear-gradient(135deg, #fff 0%, #aaa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ==========================================================================
           5. LAYOUT & VIEW CONTROLLER
           ========================================================================== */
        #app-root {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .view {
            position: absolute;
            inset: 0;
            padding: calc(20px + var(--safe-area-top)) 20px calc(100px + var(--safe-area-bottom)) 20px;
            overflow-y: auto;
            opacity: 0;
            transform: scale(0.96) translateY(10px);
            pointer-events: none;
            transition: 
                opacity var(--duration-norm) var(--ease-out),
                transform var(--duration-norm) var(--ease-out);
            scrollbar-width: none; /* Firefox */
        }
        .view::-webkit-scrollbar { display: none; }

        .view.active {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
            z-index: 10;
        }

        /* Helper for header spacing */
        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            min-height: 44px;
        }

        /* ==========================================================================
           6. COMPONENT: CARDS
           ========================================================================== */
        .card {
            background: var(--bg-card-glass);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border);
            border-radius: var(--radius-l);
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            transition: transform 0.2s, background-color 0.2s, border-color 0.2s;
            overflow: hidden;
        }

        .card:active {
            transform: scale(0.98);
            background: var(--bg-surface-2);
        }

        .card.interactive { cursor: pointer; }
        
        .card-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: var(--bg-surface-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary);
            flex-shrink: 0;
        }

        /* ==========================================================================
           7. COMPONENT: BUTTONS & INPUTS
           ========================================================================== */
        .btn {
            width: 100%;
            height: 56px;
            border-radius: var(--radius-m);
            border: none;
            font-size: 17px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, opacity 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn:active { transform: scale(0.96); opacity: 0.9; }
        
        .btn-primary { background: var(--text-main); color: #000; box-shadow: 0 4px 20px rgba(255,255,255,0.15); }
        .btn-secondary { background: var(--bg-surface-2); color: var(--text-main); }
        .btn-danger { background: var(--danger-bg); color: var(--danger); border: 1px solid rgba(255,69,58,0.2); }
        .btn-ghost { background: transparent; color: var(--primary); font-size: 15px; height: auto; padding: 10px; }
        
        .btn-sm { height: 36px; font-size: 13px; padding: 0 16px; width: auto; border-radius: 18px; }

        .inp-group { margin-bottom: 16px; }
        .inp-label { display: block; font-size: 13px; color: var(--text-ter); margin-bottom: 8px; margin-left: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .inp {
            width: 100%;
            height: 56px;
            background: var(--bg-input);
            border: 1px solid transparent;
            border-radius: var(--radius-m);
            padding: 0 20px;
            color: white;
            font-size: 17px;
            font-family: inherit;
            transition: 0.3s;
        }

        .inp:focus {
            border-color: var(--primary);
            background: #333335;
            box-shadow: 0 0 0 4px var(--primary-dim);
        }

        /* ==========================================================================
           8. COMPONENT: UNIFIED PROFILE HERO (FIXED)
           ========================================================================== */
        /* This single class handles both "Me" and "Public" profiles for consistency */
        .hero-section {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
        }

        .hero-banner {
            width: 100%;
            height: 200px;
            background: #333;
            border-radius: var(--radius-l);
            overflow: hidden;
            border: 1px solid var(--border);
            position: relative;
        }
        
        .hero-banner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.5s;
        }

        .hero-avatar {
            position: absolute;
            bottom: -50px;
            left: 24px;
            width: 100px;
            height: 100px;
            border-radius: 30px;
            background: var(--bg-card);
            border: 4px solid var(--bg-body);
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 2;
        }

        .hero-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-content {
            padding-top: 60px; /* Space for the overlapping avatar */
            padding-left: 10px;
        }

        .hero-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .stat-box {
            background: var(--bg-surface-2);
            padding: 16px;
            border-radius: var(--radius-m);
            text-align: center;
        }
        .stat-num { font-size: 20px; font-weight: 800; display: block; }
        .stat-lbl { font-size: 11px; text-transform: uppercase; color: var(--text-ter); letter-spacing: 1px; }

        /* ==========================================================================
           9. COMPONENT: NAVIGATION DOCK
           ========================================================================== */
        .dock {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            height: 70px;
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 35px;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        .dock-item {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-ter);
            transition: all 0.3s var(--ease-bounce);
            position: relative;
            cursor: pointer;
        }

        .dock-item.active {
            color: var(--text-main);
            background: var(--primary);
            transform: translateY(-15px) scale(1.1);
            box-shadow: 0 10px 20px var(--primary-glow);
        }

        .dock-item svg { width: 24px; height: 24px; fill: currentColor; }

        .badge-dot {
            position: absolute;
            top: 10px;
            right: 12px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid #222;
            display: none;
        }
        .badge-dot.show { display: block; }

        /* ==========================================================================
           10. COMPONENT: MODALS & OVERLAYS
           ========================================================================== */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            z-index: 2000; opacity: 0; pointer-events: none; display: flex; align-items: flex-end; /* Sheet style on mobile */
            transition: opacity 0.3s;
        }
        
        .overlay.open { opacity: 1; pointer-events: auto; }

        .modal-sheet {
            width: 100%;
            max-width: 500px;
            background: #1C1C1E;
            border-top: 1px solid var(--border);
            border-radius: 32px 32px 0 0;
            padding: 32px 24px 50px 24px;
            transform: translateY(100%);
            transition: transform 0.4s var(--ease-bounce);
            margin: 0 auto;
        }

        .overlay.open .modal-sheet { transform: translateY(0); }

        @media(min-width: 768px) {
            .overlay { align-items: center; justify-content: center; }
            .modal-sheet { border-radius: 32px; transform: scale(0.9); }
            .overlay.open .modal-sheet { transform: scale(1); }
        }

        /* ==========================================================================
           11. UTILITIES & ANIMATIONS
           ========================================================================== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; opacity: 0.7; cursor: pointer; font-weight: 600; padding: 8px 0; }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #2C2C2E 25%, #3A3A3C 50%, #2C2C2E 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }
        .sk-text { height: 16px; margin-bottom: 8px; width: 60%; }
        .sk-card { height: 100px; border-radius: 20px; width: 100%; }
        
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* List Animations */
        .stagger-list > * { opacity: 0; transform: translateY(20px); }
        .stagger-list.loaded > * { animation: slideInUp 0.5s var(--ease-out) forwards; }
        
        @keyframes slideInUp { to { opacity: 1; transform: translateY(0); } }
        
        /* Generate delays for up to 20 items */
        .stagger-list > *:nth-child(1) { animation-delay: 0.05s; }
        .stagger-list > *:nth-child(2) { animation-delay: 0.1s; }
        .stagger-list > *:nth-child(3) { animation-delay: 0.15s; }
        .stagger-list > *:nth-child(4) { animation-delay: 0.2s; }
        /* ... continued in logic if needed via JS style injection for large lists */

        /* Toast Notification */
        #toast-container {
            position: fixed; top: 20px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            pointer-events: none; z-index: 5000;
        }
        
        .toast {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            padding: 16px 24px;
            border-radius: 30px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: translateY(-100px);
            opacity: 0;
            transition: 0.4s var(--ease-bounce);
        }
        
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-icon { width: 10px; height: 10px; border-radius: 50%; }
        .toast.success .toast-icon { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .toast.error .toast-icon { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

    </style>
</head>
<body>

    <div class="ambient-bg"></div>
    <div class="ambient-orb"></div>
    
    <div id="toast-container"></div>

    <div id="app-root">

        <div id="view-auth" class="view active" style="z-index: 200;">
            <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div style="text-align: center; margin-bottom: 40px;">
                    <div style="width:80px; height:80px; background:linear-gradient(135deg, var(--primary), #4a00e0); border-radius:24px; margin:0 auto 20px auto; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px var(--primary-dim);">
                        <svg style="width:40px;height:40px;fill:white;" viewBox="0 0 24 24"><path d="M12,3L1,9L12,15L21,10.09V17H23V9M5,13.18V17.18L12,21L19,17.18V13.18L12,17L5,13.18Z" /></svg>
                    </div>
                    <h1>Syllabus Enterprise</h1>
                    <p>Version 3.0 Ultimate</p>
                </div>

                <div class="card" style="width: 100%; max-width: 400px;">
                    <div class="inp-group">
                        <label class="inp-label">Username</label>
                        <input id="auth-user" class="inp" type="text" placeholder="Enter username...">
                    </div>
                    <div class="inp-group">
                        <label class="inp-label">Password</label>
                        <input id="auth-pass" class="inp" type="password" placeholder="••••••••">
                    </div>
                    
                    <button id="btn-login" class="btn btn-primary" onclick="App.auth.login()">
                        Sign In
                    </button>
                    <button id="btn-signup" class="btn btn-secondary" onclick="App.auth.signup()" style="margin-top:10px;">
                        Create Account
                    </button>
                    <button class="btn btn-ghost" onclick="App.auth.guest()">Continue as Guest</button>
                </div>
            </div>
        </div>

        <div id="view-home" class="view">
            <div class="view-header">
                <div>
                    <small style="text-transform:uppercase; letter-spacing:1px; color:var(--primary);">Dashboard</small>
                    <h1>My Tables</h1>
                </div>
                <div onclick="App.router.go('settings')" style="width:44px; height:44px; background:var(--bg-surface-2); border-radius:14px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                    <svg style="width:24px;fill:var(--text-sec);" viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.95C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.95L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg>
                </div>
            </div>

            <div id="home-skeleton" class="hidden">
                <div class="skeleton sk-card mb-2"></div>
                <div class="skeleton sk-card mb-2"></div>
                <div class="skeleton sk-card"></div>
            </div>

            <div id="subject-list" class="stagger-list">
                </div>

            <button class="btn btn-primary" style="margin-top:20px;" onclick="App.modals.open('addSubject')">
                <svg style="width:20px;fill:black" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
                Create New Table
            </button>
        </div>

        <div id="view-detail" class="view">
            <div class="back-btn" onclick="App.router.go('home')">
                <svg style="width:20px;fill:white" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"/></svg>
                Back to Tables
            </div>

            <div class="card" style="background: linear-gradient(135deg, var(--primary), #0044aa); border:none; margin-top:10px;">
                <h2 id="dt-title" style="color:white">Subject Name</h2>
                <div style="display:flex; gap:10px; margin-top:5px; opacity:0.8;">
                    <span id="dt-count">0 Tasks</span>
                    <span>•</span>
                    <span id="dt-date">Updated Today</span>
                </div>
            </div>

            <div id="task-list" class="stagger-list" style="padding-bottom: 80px;">
                </div>

            <button class="btn btn-primary" onclick="App.modals.open('addTask')">Add Goal</button>
        </div>

        <div id="view-search" class="view">
            <h1>Search</h1>
            <p>Find friends to view their public tables.</p>
            
            <div class="inp-group" style="margin-top:20px;">
                <input class="inp" placeholder="Type a username..." oninput="App.controllers.search.run(this.value)">
            </div>

            <div id="search-results" class="stagger-list">
                <div style="text-align:center; padding:40px; opacity:0.5;">Start typing to search users...</div>
            </div>
        </div>

        <div id="view-profile" class="view" style="padding-top:0;">
            <div class="hero-section">
                <div class="hero-banner" onclick="App.uploader.trigger('bnr')">
                    <img id="pf-bnr" src="">
                    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; justify-content:center; align-items:center; opacity:0; transition:0.3s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0">
                        <span style="background:rgba(0,0,0,0.6); padding:5px 10px; border-radius:10px; font-size:12px;">Tap to Edit</span>
                    </div>
                </div>
                <div class="hero-avatar" onclick="App.uploader.trigger('pfp')">
                    <img id="pf-pfp" src="">
                </div>
                <div class="hero-content">
                    <h1 id="pf-name">Loading...</h1>
                    <span id="pf-badge" style="background:var(--bg-surface-2); padding:4px 12px; border-radius:12px; font-size:11px; font-weight:800; text-transform:uppercase;">MEMBER</span>
                </div>
            </div>

            <div class="hero-stats">
                <div class="stat-box">
                    <span id="pf-stat-tables" class="stat-num">0</span>
                    <span class="stat-lbl">Tables</span>
                </div>
                <div class="stat-box">
                    <span id="pf-stat-fam" class="stat-num">0</span>
                    <span class="stat-lbl">Family</span>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <h3 style="margin-bottom:15px;">Account</h3>
                <div class="inp-group">
                    <label class="inp-label">Status</label>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:10px; height:10px; background:var(--success); border-radius:50%; box-shadow:0 0 10px var(--success);"></div>
                        <span>Active</span>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="App.auth.logout()">Log Out</button>
            </div>
        </div>

        <div id="view-public" class="view" style="padding-top:0;">
            <div onclick="App.router.go('search')" style="position:absolute; top:20px; left:20px; z-index:50; background:rgba(0,0,0,0.6); backdrop-filter:blur(10px); padding:8px 16px; border-radius:20px; font-weight:bold; font-size:12px; cursor:pointer;">
                ← Return to Search
            </div>

            <div class="hero-section">
                <div class="hero-banner"><img id="pub-bnr" src=""></div>
                <div class="hero-avatar"><img id="pub-pfp" src=""></div>
                <div class="hero-content">
                    <h1 id="pub-name">User</h1>
                    <span style="opacity:0.6; font-size:13px;">Syllabus Enterprise User</span>
                </div>
            </div>

            <div style="padding: 0 10px;">
                <h4 style="margin-bottom:15px; text-transform:uppercase; font-size:12px; opacity:0.6; letter-spacing:1px;">Public Tables</h4>
                <div id="pub-list" class="stagger-list"></div>

                <div id="admin-controls" class="hidden" style="margin-top:40px; border-top:1px solid var(--border); padding-top:20px;">
                    <div style="color:var(--danger); font-weight:bold; margin-bottom:10px;">⚠️ ADMINISTRATOR ZONE</div>
                    <p style="margin-bottom:15px;">You have the authority to remove this user from the database.</p>
                    <button class="btn btn-danger" onclick="App.admin.deleteUser()">PERMANENTLY DELETE USER</button>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view">
            <div class="back-btn" onclick="App.router.go('home')">← Back</div>
            <h1>Settings</h1>

            <div class="card interactive" onclick="App.router.go('family')">
                <div class="card-row">
                    <div class="card-icon" style="background:var(--primary); color:white;">
                        <svg style="width:24px;fill:currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    </div>
                    <div>
                        <b>Family Center</b>
                        <div style="font-size:13px; opacity:0.6;">Manage invites & connections</div>
                    </div>
                    <div style="margin-left:auto; opacity:0.5;">➜</div>
                </div>
            </div>
            
            <div class="card">
                <h3>Application</h3>
                <div class="card-row" style="margin-top:15px; justify-content:space-between;">
                    <span>Theme</span>
                    <span style="opacity:0.5">Dark (System)</span>
                </div>
                <div class="card-row" style="margin-top:15px; justify-content:space-between;">
                    <span>Version</span>
                    <span style="opacity:0.5">3.0.1 Ent</span>
                </div>
                <div class="card-row" style="margin-top:15px; justify-content:space-between;">
                    <span>Storage</span>
                    <span style="opacity:0.5" id="storage-usage">Calculating...</span>
                </div>
            </div>
        </div>

        <div id="view-family" class="view">
            <div class="back-btn" onclick="App.router.go('settings')">← Back to Settings</div>
            <h1>Family Center</h1>
            <p>Connect with your family members here.</p>

            <div class="card" style="margin-top:20px; border:1px solid var(--primary-dim);">
                <h3>Invite Member</h3>
                <p style="margin-bottom:15px;">Enter the exact username.</p>
                <div style="display:flex; gap:10px;">
                    <input id="fam-invite-inp" class="inp" placeholder="Username">
                    <button class="btn btn-primary" style="width:auto; padding:0 20px;" onclick="App.controllers.family.sendInvite()">Send</button>
                </div>
            </div>

            <div id="section-invites" class="hidden">
                <h4 style="margin:20px 0 10px 0; color:var(--primary);">PENDING REQUESTS</h4>
                <div id="list-invites"></div>
            </div>

            <h4 style="margin:30px 0 10px 0; opacity:0.5; font-size:12px; letter-spacing:1px;">MY CONNECTIONS</h4>
            <div id="list-family" class="stagger-list"></div>
        </div>

    </div> <div id="dock" class="dock">
        <div class="dock-item active" data-target="home" onclick="App.router.go('home')">
            <svg viewBox="0 0 24 24"><path d="M3,13H11V3H3V13M3,21H11V15H3V21M13,21H21V11H13V21M13,3V9H21V3H13Z" /></svg>
        </div>
        <div class="dock-item" data-target="search" onclick="App.router.go('search')">
            <svg viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        </div>
        <div class="dock-item" data-target="profile" onclick="App.router.go('profile')">
            <div id="dock-badge" class="badge-dot"></div>
            <svg viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" /></svg>
        </div>
    </div>

    <div id="modal-overlay" class="overlay">
        <div class="modal-sheet">
            <h2 id="modal-title">Title</h2>
            <div id="modal-body" style="margin-top:20px;"></div>
            <div id="modal-footer" style="margin-top:30px;"></div>
        </div>
    </div>

    <input type="file" id="file-input" hidden accept="image/*" onchange="App.uploader.process(this)">


    <script>
        /**
         * SYLLABUS ENTERPRISE CORE V3
         * Architecture: MVC-ish with centralized Store and Service Layers
         */

        /* --- 1. CONFIGURATION --- */
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyC2ryrcM8eRTUIkBrVitQUWn2x5oTbbnmE",
                authDomain: "syllabuspro-4ec5c.firebaseapp.com",
                projectId: "syllabuspro-4ec5c",
                databaseURL: "https://syllabuspro-4ec5c-default-rtdb.asia-southeast1.firebasedatabase.app/",
                storageBucket: "syllabuspro-4ec5c.firebasestorage.app"
            },
            defaults: {
                banner: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=800&q=80',
                pfp: 'https://api.dicebear.com/7.x/initials/svg?seed=',
                guestName: 'Guest User'
            }
        };

        /* --- 2. UTILITIES SERVICE --- */
        class Utils {
            static generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            static formatDate(dateStr) {
                if(!dateStr) return '';
                const date = new Date(dateStr);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (date.toDateString() === now.toDateString()) return '<span style="color:var(--success)">Due Today</span>';
                if (date < now) return '<span style="color:var(--danger)">Overdue</span>';
                return `Due in ${diffDays} days`;
            }

            static toast(msg, type = 'success') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast ${type}`;
                el.innerHTML = `<div class="toast-icon"></div><span>${msg}</span>`;
                container.appendChild(el);
                
                // Animation Cycle
                requestAnimationFrame(() => {
                    el.classList.add('show');
                    setTimeout(() => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 400);
                    }, 3000);
                });
            }

            static storageCalc(data) {
                const json = JSON.stringify(data);
                const bytes = new Blob([json]).size;
                return (bytes / 1024).toFixed(2) + " KB";
            }
        }

        /* --- 3. STORE (STATE MANAGEMENT) --- */
        class Store {
            constructor() {
                this.state = {
                    user: null, // Username
                    pass: null, // Password
                    data: null, // Full DB dump for user
                    currentSubIndex: null,
                    viewingUser: null, // For Public profile
                    uploadType: null // 'bnr' or 'pfp'
                };
            }

            setUser(u, p) {
                this.state.user = u;
                this.state.pass = p;
                if(u) {
                    localStorage.setItem('syll_u', u);
                    localStorage.setItem('syll_p', p);
                } else {
                    localStorage.removeItem('syll_u');
                    localStorage.removeItem('syll_p');
                }
            }

            loadSession() {
                return {
                    u: localStorage.getItem('syll_u'),
                    p: localStorage.getItem('syll_p')
                };
            }
        }

        /* --- 4. FIREBASE SERVICE --- */
        class DBService {
            constructor() {
                firebase.initializeApp(CONFIG.firebase);
                this.db = firebase.database();
                this.ref = null; // User ref
            }

            async login(u, p) {
                const snap = await this.db.ref('users/' + u).once('value');
                if (!snap.exists()) throw new Error("User does not exist");
                if (snap.val().pass !== p) throw new Error("Incorrect Password");
                return snap.val();
            }

            async signup(u, p) {
                const ref = this.db.ref('users/' + u);
                const snap = await ref.once('value');
                if (snap.exists()) throw new Error("Username taken");
                
                const payload = {
                    user: u,
                    pass: p,
                    joined: Date.now(),
                    subjects: [],
                    invites: [],
                    family: [],
                    pfp: "",
                    bnr: ""
                };
                await ref.set(payload);
                return payload;
            }

            listen(u, callback) {
                if(this.ref) this.ref.off();
                this.ref = this.db.ref('users/' + u);
                this.ref.on('value', (snap) => {
                    const val = snap.val();
                    if(val) callback(val);
                    else App.auth.logout(); // User deleted remotely
                });
            }
            
            async update(path, val) {
                if(!App.store.state.user) return;
                await this.db.ref('users/' + App.store.state.user + '/' + path).set(val);
            }

            async search(query) {
                const snap = await this.db.ref('users').once('value');
                const results = [];
                snap.forEach(child => {
                    const val = child.val();
                    if (val.user && val.user.toLowerCase().includes(query.toLowerCase())) {
                        results.push(val);
                    }
                });
                return results;
            }

            async getPublic(username) {
                const snap = await this.db.ref('users/' + username).once('value');
                return snap.exists() ? snap.val() : null;
            }
            
            async invite(target) {
                const ref = this.db.ref('users/' + target + '/invites');
                const snap = await ref.once('value');
                let invites = snap.val() || [];
                if(invites.includes(App.store.state.user)) throw new Error("Already invited");
                invites.push(App.store.state.user);
                await ref.set(invites);
            }
            
            async deleteUser(target) {
                await this.db.ref('users/' + target).remove();
            }
        }

        /* --- 5. ROUTER --- */
        class Router {
            constructor() {
                this.routes = ['auth', 'home', 'detail', 'search', 'profile', 'public', 'settings', 'family'];
                this.history = [];
            }

            go(viewId) {
                // Hide all
                this.routes.forEach(r => document.getElementById('view-' + r).classList.remove('active'));
                
                // Show target
                document.getElementById('view-' + viewId).classList.add('active');
                
                // Update Dock
                document.querySelectorAll('.dock-item').forEach(el => {
                    el.classList.remove('active');
                    if(el.dataset.target === viewId) el.classList.add('active');
                });

                // Dock Visibility logic
                const dock = document.getElementById('dock');
                if(['auth', 'detail', 'settings', 'family'].includes(viewId)) {
                    dock.style.transform = 'translate(-50%, 100px)'; // Hide down
                } else {
                    dock.style.transform = 'translate(-50%, 0)'; // Show
                }

                // Logic Triggers
                if(viewId === 'search') document.getElementById('search-results').innerHTML = '<div style="text-align:center; padding:40px; opacity:0.5;">Start typing to search...</div>';
            }
        }

        /* --- 6. VIEW CONTROLLERS --- */
        class Controllers {
            constructor() {
                this.home = {
                    render: (data) => {
                        const list = document.getElementById('subject-list');
                        const skeleton = document.getElementById('home-skeleton');
                        
                        list.innerHTML = "";
                        
                        if(!data.subjects || data.subjects.length === 0) {
                            list.innerHTML = `<div class="card text-center" style="padding:40px; border-style:dashed; opacity:0.6;">No tables yet.<br>Create one to begin.</div>`;
                            return;
                        }

                        data.subjects.forEach((sub, idx) => {
                            const taskCount = sub.tasks ? sub.tasks.length : 0;
                            // Calculate progress
                            const item = document.createElement('div');
                            item.className = 'card interactive';
                            item.onclick = () => App.controllers.detail.open(idx);
                            item.innerHTML = `
                                <div class="card-row">
                                    <div class="card-icon" style="background:var(--bg-surface-2);">
                                        <span style="font-weight:800; opacity:0.7;">${sub.name.charAt(0).toUpperCase()}</span>
                                    </div>
                                    <div style="flex:1">
                                        <b>${sub.name}</b>
                                        <div style="font-size:12px; margin-top:4px; color:var(--text-sec)">${taskCount} Goals Active</div>
                                        <div style="height:4px; background:#333; margin-top:8px; border-radius:2px; overflow:hidden;">
                                            <div style="width:${Math.random() * 100}%; height:100%; background:var(--primary);"></div>
                                        </div>
                                    </div>
                                    <div style="opacity:0.3">➜</div>
                                </div>
                            `;
                            list.appendChild(item);
                        });
                        
                        list.classList.add('loaded');
                    }
                };

                this.detail = {
                    open: (idx) => {
                        App.store.state.currentSubIndex = idx;
                        const sub = App.store.state.data.subjects[idx];
                        
                        document.getElementById('dt-title').innerText = sub.name;
                        document.getElementById('dt-count').innerText = (sub.tasks || []).length + " Tasks";
                        
                        const list = document.getElementById('task-list');
                        list.innerHTML = "";
                        
                        if(!sub.tasks || sub.tasks.length === 0) {
                            list.innerHTML = `<div style="text-align:center; opacity:0.5; margin-top:50px;">No goals added yet.</div>`;
                        } else {
                            sub.tasks.forEach(t => {
                                const el = document.createElement('div');
                                el.className = 'card';
                                el.innerHTML = `
                                    <div style="display:flex; justify-content:space-between; align-items:start;">
                                        <b>${t.desc}</b>
                                        <div style="font-size:12px; background:var(--bg-surface-2); padding:4px 8px; border-radius:6px;">
                                            ${Utils.formatDate(t.date)}
                                        </div>
                                    </div>
                                `;
                                list.appendChild(el);
                            });
                            list.classList.add('loaded');
                        }
                        
                        App.router.go('detail');
                    }
                };

                this.search = {
                    run: async (q) => {
                        if(!q) return;
                        const container = document.getElementById('search-results');
                        container.innerHTML = '<div class="text-center" style="padding:20px;">Searching...</div>';
                        
                        const results = await App.db.search(q);
                        container.innerHTML = "";
                        
                        if(results.length === 0) {
                            container.innerHTML = `<div class="text-center" style="opacity:0.5; padding:20px;">No users found.</div>`;
                            return;
                        }

                        results.forEach(u => {
                            const el = document.createElement('div');
                            el.className = 'card interactive';
                            el.onclick = () => App.controllers.public.view(u.user);
                            el.innerHTML = `
                                <div class="card-row">
                                    <img src="${u.pfp || CONFIG.defaults.pfp + u.user}" style="width:40px; height:40px; border-radius:12px; object-fit:cover;">
                                    <div>
                                        <b>${u.user}</b>
                                        <div style="font-size:12px; opacity:0.5;">${(u.subjects||[]).length} Tables</div>
                                    </div>
                                </div>
                            `;
                            container.appendChild(el);
                        });
                        container.classList.add('loaded');
                    }
                };
                
                this.public = {
                    view: async (username) => {
                        App.router.go('public');
                        document.getElementById('pub-name').innerText = "Loading...";
                        
                        const data = await App.db.getPublic(username);
                        App.store.state.viewingUser = username; // Set state for Admin

                        if(!data) { Utils.toast("Error loading profile", "error"); return; }
                        
                        // Populate Public Profile
                        document.getElementById('pub-name').innerText = data.user;
                        document.getElementById('pub-bnr').src = data.bnr || CONFIG.defaults.banner;
                        document.getElementById('pub-pfp').src = data.pfp || CONFIG.defaults.pfp + data.user;
                        
                        const list = document.getElementById('pub-list');
                        list.innerHTML = "";
                        
                        if(!data.subjects || data.subjects.length === 0) {
                            list.innerHTML = `<div class="card" style="opacity:0.6">No public tables.</div>`;
                        } else {
                            data.subjects.forEach(s => {
                                list.innerHTML += `
                                    <div class="card">
                                        <b>${s.name}</b>
                                        <div style="font-size:12px; opacity:0.6; margin-top:5px;">${(s.tasks||[]).length} Goals</div>
                                    </div>
                                `;
                            });
                        }
                        
                        // Admin Check
                        const adminPanel = document.getElementById('admin-controls');
                        if(App.store.state.user === 'Admin' && username !== 'Admin') {
                            adminPanel.classList.remove('hidden');
                        } else {
                            adminPanel.classList.add('hidden');
                        }
                    }
                };

                this.family = {
                    render: () => {
                        const data = App.store.state.data;
                        const invList = document.getElementById('list-invites');
                        const famList = document.getElementById('list-family');
                        const sectionInv = document.getElementById('section-invites');
                        const badge = document.getElementById('dock-badge');

                        // Handle Invites
                        const invites = data.invites || [];
                        if(invites.length > 0) {
                            sectionInv.classList.remove('hidden');
                            badge.classList.add('show');
                            invList.innerHTML = invites.map(name => `
                                <div class="card">
                                    <div class="card-row">
                                        <div class="card-icon" style="border-radius:50%; width:36px; height:36px; font-size:14px;">${name.charAt(0)}</div>
                                        <div><b>${name}</b><br><small>Wants to connect</small></div>
                                    </div>
                                    <div style="display:flex; gap:10px; margin-top:15px;">
                                        <button class="btn btn-primary btn-sm" onclick="App.controllers.family.reply('${name}', true)">Accept</button>
                                        <button class="btn btn-secondary btn-sm" onclick="App.controllers.family.reply('${name}', false)">Deny</button>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            sectionInv.classList.add('hidden');
                            badge.classList.remove('show');
                        }

                        // Handle Family List
                        const family = data.family || [];
                        famList.innerHTML = "";
                        if(family.length === 0) {
                            famList.innerHTML = `<div class="text-center" style="opacity:0.5; padding:20px;">You are alone in the universe.</div>`;
                        } else {
                            family.forEach(f => {
                                const el = document.createElement('div');
                                el.className = 'card interactive';
                                el.onclick = () => App.controllers.public.view(f);
                                el.innerHTML = `
                                    <div class="card-row">
                                        <div style="width:10px; height:10px; background:var(--success); border-radius:50%;"></div>
                                        <b>${f}</b>
                                    </div>
                                `;
                                famList.appendChild(el);
                            });
                        }
                    },
                    
                    sendInvite: async () => {
                        const target = document.getElementById('fam-invite-inp').value.trim();
                        if(!target || target === App.store.state.user) return Utils.toast("Invalid username", "error");
                        
                        try {
                            const u = await App.db.getPublic(target);
                            if(!u) throw new Error("User not found");
                            await App.db.invite(target);
                            Utils.toast(`Invite sent to ${target}`);
                            document.getElementById('fam-invite-inp').value = "";
                        } catch(e) {
                            Utils.toast(e.message, "error");
                        }
                    },
                    
                    reply: async (sender, accept) => {
                        const myData = App.store.state.data;
                        let newInvites = (myData.invites || []).filter(i => i !== sender);
                        let newFamily = myData.family || [];

                        if(accept) {
                            if(!newFamily.includes(sender)) newFamily.push(sender);
                            
                            // 1. Update Me
                            await App.db.update('invites', newInvites);
                            await App.db.update('family', newFamily);

                            // 2. Update Sender (Bi-directional)
                            // Note: In a real backend this is server-side. Here we hack it via client.
                            const senderData = await App.db.getPublic(sender);
                            let senderFam = senderData.family || [];
                            if(!senderFam.includes(App.store.state.user)) senderFam.push(App.store.state.user);
                            await firebase.database().ref('users/'+sender+'/family').set(senderFam);
                            
                            Utils.toast(`Connected with ${sender}`);
                        } else {
                            await App.db.update('invites', newInvites);
                            Utils.toast("Request ignored");
                        }
                    }
                };
            }
        }

        /* --- 7. MAIN APP CLASS --- */
        class Application {
            constructor() {
                this.store = new Store();
                this.db = new DBService();
                this.router = new Router();
                this.controllers = new Controllers();
                
                this.init();
            }

            init() {
                // Check session
                const session = this.store.loadSession();
                if (session.u && session.p) {
                    this.auth.autoLogin(session.u, session.p);
                } else {
                    this.router.go('auth');
                }
            }

            /* AUTH MODULE */
            auth = {
                login: async () => {
                    const u = document.getElementById('auth-user').value.trim();
                    const p = document.getElementById('auth-pass').value.trim();
                    if(!u || !p) return Utils.toast("Fill all fields", "error");
                    
                    try {
                        await App.db.login(u, p);
                        App.store.setUser(u, p);
                        this.auth.startSession(u);
                        Utils.toast("Welcome Back");
                    } catch(e) {
                        Utils.toast(e.message, "error");
                    }
                },
                
                signup: async () => {
                    const u = document.getElementById('auth-user').value.trim();
                    const p = document.getElementById('auth-pass').value.trim();
                    if(!u || !p) return Utils.toast("Fill all fields", "error");
                    
                    try {
                        await App.db.signup(u, p);
                        App.store.setUser(u, p);
                        this.auth.startSession(u);
                        Utils.toast("Account Created");
                    } catch(e) {
                        Utils.toast(e.message, "error");
                    }
                },
                
                autoLogin: async (u, p) => {
                    try {
                        await App.db.login(u, p);
                        App.store.setUser(u, p);
                        this.auth.startSession(u);
                    } catch(e) {
                        this.store.setUser(null, null);
                        App.router.go('auth');
                    }
                },
                
                startSession: (user) => {
                    // Set up listeners
                    App.db.listen(user, (data) => {
                        App.store.state.data = data;
                        
                        // Update Profile UI
                        document.getElementById('pf-name').innerText = data.user;
                        document.getElementById('pf-bnr').src = data.bnr || CONFIG.defaults.banner;
                        document.getElementById('pf-pfp').src = data.pfp || CONFIG.defaults.pfp + data.user;
                        document.getElementById('pf-stat-tables').innerText = (data.subjects||[]).length;
                        document.getElementById('pf-stat-fam').innerText = (data.family||[]).length;
                        
                        document.getElementById('pf-badge').innerText = data.user === 'Admin' ? 'ADMINISTRATOR' : 'PRO MEMBER';
                        if(data.user === 'Admin') document.getElementById('pf-badge').style.background = 'var(--danger)';

                        document.getElementById('storage-usage').innerText = Utils.storageCalc(data);

                        // Render Current Views
                        App.controllers.home.render(data);
                        App.controllers.family.render();
                    });
                    
                    App.router.go('home');
                },

                logout: () => {
                    App.store.setUser(null, null);
                    location.reload();
                },

                guest: () => {
                    App.router.go('home');
                    document.getElementById('subject-list').innerHTML = `<div class="card text-center">Guest Mode<br><small>Data not saved</small></div>`;
                    document.getElementById('pf-name').innerText = "Guest";
                    document.getElementById('dock').style.display = "none";
                }
            };

            /* MODAL MODULE */
            modals = {
                open: (type) => {
                    const overlay = document.getElementById('modal-overlay');
                    const title = document.getElementById('modal-title');
                    const body = document.getElementById('modal-body');
                    const footer = document.getElementById('modal-footer');
                    
                    overlay.classList.add('open');
                    
                    if(type === 'addSubject') {
                        title.innerText = "New Table";
                        body.innerHTML = `<div class="inp-group"><label class="inp-label">Name</label><input id="m-inp-1" class="inp" placeholder="e.g. Physics"></div>`;
                        footer.innerHTML = `<button class="btn btn-primary" onclick="App.actions.createSubject()">Create</button><button class="btn btn-ghost" onclick="App.modals.close()">Cancel</button>`;
                    } else if (type === 'addTask') {
                        title.innerText = "New Goal";
                        body.innerHTML = `
                            <div class="inp-group"><label class="inp-label">Goal</label><input id="m-inp-1" class="inp" placeholder="Description"></div>
                            <div class="inp-group"><label class="inp-label">Target Date</label><input id="m-inp-2" class="inp" type="date"></div>
                        `;
                        footer.innerHTML = `<button class="btn btn-primary" onclick="App.actions.createTask()">Add Goal</button><button class="btn btn-ghost" onclick="App.modals.close()">Cancel</button>`;
                    }
                },
                close: () => {
                    document.getElementById('modal-overlay').classList.remove('open');
                }
            };

            /* ACTIONS (CRUD) */
            actions = {
                createSubject: async () => {
                    const name = document.getElementById('m-inp-1').value;
                    if(!name) return;
                    
                    const subs = App.store.state.data.subjects || [];
                    subs.push({ name: name, tasks: [], created: Date.now() });
                    
                    await App.db.update('subjects', subs);
                    App.modals.close();
                    Utils.toast("Table Created");
                },
                
                createTask: async () => {
                    const desc = document.getElementById('m-inp-1').value;
                    const date = document.getElementById('m-inp-2').value;
                    if(!desc || !date) return;
                    
                    const subs = App.store.state.data.subjects;
                    const idx = App.store.state.currentSubIndex;
                    
                    subs[idx].tasks = subs[idx].tasks || [];
                    subs[idx].tasks.push({ desc, date });
                    
                    await App.db.update('subjects', subs);
                    App.modals.close();
                    App.controllers.detail.open(idx); // Refresh detail view
                    Utils.toast("Goal Added");
                }
            };

            /* ADMIN MODULE */
            admin = {
                deleteUser: async () => {
                    const target = App.store.state.viewingUser;
                    if(!target) return;
                    if(confirm(`CRITICAL: Are you sure you want to delete ${target}?`)) {
                        await App.db.deleteUser(target);
                        Utils.toast("User Deleted", "success");
                        App.router.go('search');
                    }
                }
            };

            /* UPLOADER MODULE */
            uploader = {
                trigger: (type) => {
                    App.store.state.uploadType = type;
                    document.getElementById('file-input').click();
                },
                process: (input) => {
                    if (input.files && input.files[0]) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const type = App.store.state.uploadType;
                            await App.db.update(type, e.target.result);
                            Utils.toast("Image Updated");
                        };
                        reader.readAsDataURL(input.files[0]);
                    }
                }
            };
        }

        /* --- 8. BOOTSTRAP --- */
        const App = new Application();

    </script>
</body>
</html>
