<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SyllabusStudy Enterprise</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* =========================================
           1. RESET & VARIABLES
           ========================================= */
        :root {
            --primary: #0A84FF;
            --primary-dim: rgba(10, 132, 255, 0.2);
            --danger: #FF453A;
            --danger-dim: rgba(255, 69, 58, 0.2);
            --success: #30D158;
            --warning: #FFD60A;
            
            --bg-root: #000000;
            --bg-card: #1C1C1E;
            --bg-card-glass: rgba(28, 28, 30, 0.75);
            --bg-input: #2C2C2E;
            
            --text-main: #FFFFFF;
            --text-sec: #EBEBF599; /* 60% opacity */
            --text-ter: #EBEBF54D; /* 30% opacity */
            
            --border: rgba(254, 254, 254, 0.15);
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 10px;
            
            --anim-speed: 0.35s;
            --anim-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --anim-smooth: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            background-color: var(--bg-root);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
            line-height: 1.5;
        }

        /* =========================================
           2. ANIMATED BACKGROUND
           ========================================= */
        .background-fx {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 10% 20%, #1a1a2e 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, #16213e 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, #000000 0%, #000000 100%);
            animation: breatheBg 15s ease-in-out infinite alternate;
        }

        @keyframes breatheBg {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        /* =========================================
           3. TYPOGRAPHY
           ========================================= */
        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 700; letter-spacing: -0.5px; }
        h1 { font-size: 34px; margin-bottom: 8px; }
        h2 { font-size: 28px; }
        h3 { font-size: 22px; }
        p { margin: 0; color: var(--text-sec); font-size: 15px; }
        small { font-size: 13px; color: var(--text-ter); }

        /* =========================================
           4. LAYOUT COMPONENTS
           ========================================= */
        .screen-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .view {
            position: absolute;
            inset: 0;
            padding: 70px 20px 120px 20px; /* Top, Right, Bottom (Dock), Left */
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95) translateY(10px);
            transition: opacity var(--anim-speed) var(--anim-smooth), 
                        transform var(--anim-speed) var(--anim-smooth);
            scrollbar-width: none;
        }

        .view::-webkit-scrollbar { display: none; }

        .view.active {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1) translateY(0);
        }

        /* =========================================
           5. UI CARDS & LISTS
           ========================================= */
        .card {
            background: var(--bg-card-glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: var(--radius-l);
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            transition: transform 0.2s ease, background 0.2s;
            overflow: hidden;
        }

        .card:active { transform: scale(0.98); background: #2c2c2e; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .list-empty {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.5;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        /* =========================================
           6. INPUTS & BUTTONS
           ========================================= */
        .input-group { margin-bottom: 15px; }
        
        .inp {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid transparent;
            color: white;
            padding: 18px 20px;
            border-radius: var(--radius-m);
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .inp:focus {
            border-color: var(--primary);
            background: #3a3a3c;
            box-shadow: 0 0 0 4px var(--primary-dim);
        }

        .inp::placeholder { color: var(--text-ter); }

        .btn {
            width: 100%;
            padding: 18px;
            border-radius: var(--radius-m);
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, opacity 0.2s;
            margin-top: 10px;
        }

        .btn:active { transform: scale(0.96); opacity: 0.8; }

        .btn-primary { background: white; color: black; box-shadow: 0 4px 15px rgba(255,255,255,0.1); }
        .btn-secondary { background: var(--bg-input); color: white; }
        .btn-danger { background: var(--danger-dim); color: var(--danger); border: 1px solid rgba(255,69,58,0.3); }
        .btn-ghost { background: transparent; color: var(--primary); font-size: 14px; padding: 10px; }

        .icon-svg { width: 20px; height: 20px; fill: currentColor; }

        /* =========================================
           7. PROFILE COMPONENTS
           ========================================= */
        .profile-header { position: relative; margin-bottom: 20px; }

        .banner-container {
            width: 100%;
            height: 180px;
            border-radius: var(--radius-l);
            overflow: hidden;
            background: #333;
            border: 1px solid var(--border);
        }
        
        .banner-img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }

        .avatar-container {
            width: 100px;
            height: 100px;
            border-radius: 30px;
            background: #222;
            border: 5px solid #000;
            position: absolute;
            bottom: -50px;
            left: 20px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 5;
        }
        
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-admin { background: var(--danger); color: white; }
        .badge-pro { background: var(--primary); color: white; }
        .badge-guest { background: var(--bg-input); color: var(--text-sec); }

        /* =========================================
           8. NAVIGATION DOCK
           ========================================= */
        .dock {
            position: fixed;
            bottom: 24px;
            left: 24px;
            right: 24px;
            height: 80px;
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border-radius: 40px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }

        .dock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            width: 60px;
            height: 60px;
            opacity: 0.5;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .dock-item.active {
            opacity: 1;
            transform: translateY(-5px);
            color: var(--primary);
        }

        .dock-item svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            filter: drop-shadow(0 0 0 transparent);
            transition: 0.3s;
        }
        
        .dock-item.active svg {
            filter: drop-shadow(0 0 10px var(--primary-dim));
        }

        .dock-label { font-size: 10px; font-weight: 700; }

        .notification-dot {
            width: 10px;
            height: 10px;
            background: var(--danger);
            border: 2px solid #000;
            border-radius: 50%;
            position: absolute;
            top: 10px;
            right: 12px;
            transform: scale(0);
            transition: transform 0.3s var(--anim-bounce);
        }
        .notification-dot.show { transform: scale(1); }

        /* =========================================
           9. MODALS & OVERLAYS
           ========================================= */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }

        .overlay.open { opacity: 1; pointer-events: auto; }

        .modal {
            width: 90%;
            max-width: 400px;
            background: #1C1C1E;
            border: 1px solid var(--border);
            border-radius: 32px;
            padding: 32px;
            transform: scale(0.8);
            transition: transform 0.4s var(--anim-bounce);
            box-shadow: 0 25px 50px rgba(0,0,0,0.7);
        }

        .overlay.open .modal { transform: scale(1); }

        /* =========================================
           10. TOAST NOTIFICATIONS
           ========================================= */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 90%;
            max-width: 350px;
            pointer-events: none;
        }

        .toast {
            background: rgba(40, 40, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            color: white;
            padding: 16px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideDownToast 0.4s var(--anim-bounce) forwards;
            pointer-events: auto;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

        @keyframes slideDownToast {
            from { opacity: 0; transform: translateY(-20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* =========================================
           11. LOADING SPINNER
           ========================================= */
        .loader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 4000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }
        .loader-overlay.show { opacity: 1; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* =========================================
           12. STAGGERED LIST ANIMATIONS
           ========================================= */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .anim-item { opacity: 0; animation: slideUpFade 0.5s var(--anim-smooth) forwards; }

        /* =========================================
           13. UTILITIES
           ========================================= */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mt-4 { margin-top: 40px; }
        
        .shake { animation: shake 0.4s ease-in-out; border-color: var(--danger) !important; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-6px); }
            40%, 80% { transform: translateX(6px); }
        }

    </style>
</head>
<body>

    <div class="background-fx"></div>

    <div class="screen-container">

        <div id="view-home" class="view active">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>Tables</h1>
                <div onclick="Router.to('settings')" style="background:var(--bg-input); padding:10px; border-radius:50%; cursor:pointer;">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
                </div>
            </div>
            <p>Organize your academic goals.</p>
            
            <div id="list-subjects" class="mt-2"></div>
            
            <button class="btn btn-primary" onclick="Modals.open('add-subject')">
                <svg class="icon-svg" style="fill:black" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Create New Table
            </button>
        </div>

        <div id="view-detail" class="view">
            <div onclick="Router.to('home')" style="display:flex; align-items:center; gap:8px; opacity:0.7; cursor:pointer; margin-bottom:15px;">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"/></svg>
                <b>Back</b>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, var(--primary), #0062cc); border:none;">
                <h2 id="detail-title">Mathematics</h2>
                <div style="display:flex; align-items:center; gap:6px; opacity:0.8; margin-top:5px;">
                    <svg class="icon-svg" style="width:16px;" viewBox="0 0 24 24"><path d="M14,10H19.5L14,4.5V10M5,3H15L21,9V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5C3,3.89 3.89,3 5,3M5,5V19H19V12H12V5H5Z"/></svg>
                    <span id="detail-count">0 Goals</span>
                </div>
            </div>

            <div id="list-tasks" class="mt-2"></div>
            
            <button class="btn btn-primary" onclick="Modals.open('add-task')">Add Goal</button>
        </div>

        <div id="view-search" class="view">
            <h1>Search</h1>
            <p>Find friends and family.</p>
            <div class="input-group mt-2">
                <input class="inp" placeholder="Type a username..." oninput="Core.search(this.value)">
            </div>
            <div id="list-search"></div>
        </div>

        <div id="view-msgs" class="view">
            <h1>Inbox</h1>
            <p>Connection requests.</p>
            <div id="list-msgs" class="mt-2"></div>
        </div>

        <div id="view-profile" class="view" style="padding-top:0;">
            <div class="profile-header">
                <div class="banner-container" onclick="Core.triggerUpload('bnr')">
                    <img id="pf-bnr" class="banner-img" src="">
                    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; justify-content:center; align-items:center; opacity:0;">Tap to Edit</div>
                </div>
                <div class="avatar-container" onclick="Core.triggerUpload('pfp')">
                    <img id="pf-pfp" class="avatar-img" src="">
                </div>
            </div>
            
            <div style="padding-top: 50px;">
                <h1 id="pf-name">Loading...</h1>
                <div id="pf-badge-container"></div>
                
                <div id="guest-ctrl" class="hidden mt-4">
                    <div class="card">
                        <h3>Sync Data</h3>
                        <p class="mt-1">Create an account to save your tables, connect with family, and access the platform from any device.</p>
                    </div>
                    <button class="btn btn-primary" onclick="Modals.open('auth-signup')">Create Account</button>
                    <button class="btn btn-secondary" onclick="Modals.open('auth-login')">Log In</button>
                </div>

                <div id="user-ctrl" class="hidden mt-4">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                        <div class="card text-center">
                            <h2 id="stat-tables">0</h2>
                            <small>TABLES</small>
                        </div>
                        <div class="card text-center">
                            <h2 id="stat-fam">0</h2>
                            <small>FAMILY</small>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="Core.logout()">Log Out</button>
                </div>
            </div>
        </div>

        <div id="view-public" class="view" style="padding-top:0;">
            <div onclick="Router.to('search')" style="position:absolute; top:20px; left:20px; z-index:100; background:rgba(0,0,0,0.5); backdrop-filter:blur(10px); padding:8px 16px; border-radius:20px; font-weight:bold; cursor:pointer;">
                &larr; Return
            </div>
            
            <div class="banner-container">
                <img id="pub-bnr" class="banner-img" src="">
            </div>
            <div class="avatar-container" style="bottom:-40px;">
                <img id="pub-pfp" class="avatar-img" src="">
            </div>

            <div style="padding-top: 50px;">
                <h1 id="pub-name">User</h1>
                <div class="mt-4">
                    <h4 style="text-transform:uppercase; font-size:12px; opacity:0.6; letter-spacing:1px; margin-bottom:10px;">Public Tables</h4>
                    <div id="pub-list"></div>
                </div>

                <div id="admin-panel" class="hidden" style="margin-top:50px; border-top:1px solid var(--border); padding-top:20px;">
                    <div style="display:flex; align-items:center; gap:10px; color:var(--danger); margin-bottom:10px;">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12,2L1,21H23M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16"/></svg>
                        <b style="font-size:18px;">ADMINISTRATOR ZONE</b>
                    </div>
                    <p style="margin-bottom:15px;">You have elevated privileges. This action cannot be undone.</p>
                    <button class="btn btn-danger" onclick="Core.adminDeleteUser()">PERMANENTLY DELETE USER</button>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view">
             <div onclick="Router.to('home')" style="display:flex; align-items:center; gap:8px; opacity:0.7; cursor:pointer; margin-bottom:15px;">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"/></svg>
                <b>Back</b>
            </div>
            <h1>Settings</h1>
            <div class="card mt-2">
                <div class="card-header">
                    <span>App Version</span>
                    <span style="opacity:0.5">Enterprise v2.1</span>
                </div>
            </div>
            <div class="card">
                <h3>About</h3>
                <p class="mt-1">SyllabusStudy Enterprise Edition designed for robust task management.</p>
            </div>
        </div>

    </div>
    <div id="toast-area" class="toast-container"></div>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>

    <div id="modal-overlay" class="overlay">
        <div class="modal">
            <h2 id="modal-title">Title</h2>
            <div id="modal-content" class="mt-2"></div>
            <div id="modal-actions" class="mt-4"></div>
        </div>
    </div>

    <input type="file" id="file-hidden" style="display:none" accept="image/*" onchange="Core.processUpload(this)">

    <div class="dock">
        <div class="dock-item active" onclick="Router.to('home', this)">
            <svg viewBox="0 0 24 24"><path d="M18,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V4A2,2 0 0,0 18,2M13,13H11V11H13M13,9H11V7H13M13,17H11V15H13"/></svg>
            <span class="dock-label">Tables</span>
        </div>
        <div class="dock-item" onclick="Router.to('search', this)">
            <svg viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/></svg>
            <span class="dock-label">Search</span>
        </div>
        <div class="dock-item" onclick="Router.to('msgs', this)">
            <div id="notif-badge" class="notification-dot"></div>
            <svg viewBox="0 0 24 24"><path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M6,9H18V11H6M14,14H6V12H14M18,8H6V6H18"/></svg>
            <span class="dock-label">Inbox</span>
        </div>
        <div class="dock-item" onclick="Router.to('profile', this)">
            <svg viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>
            <span class="dock-label">Me</span>
        </div>
    </div>

<script>
    /* --- CONFIGURATION & CONSTANTS --- */
    const CONFIG = {
        firebase: {
            apiKey: "AIzaSyC2ryrcM8eRTUIkBrVitQUWn2x5oTbbnmE",
            authDomain: "syllabuspro-4ec5c.firebaseapp.com",
            projectId: "syllabuspro-4ec5c",
            databaseURL: "https://syllabuspro-4ec5c-default-rtdb.asia-southeast1.firebasedatabase.app/",
            storageBucket: "syllabuspro-4ec5c.firebasestorage.app"
        },
        defaults: {
            banner: 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=800&q=80',
            pfp: 'https://api.dicebear.com/7.x/initials/svg?seed='
        }
    };

    /* --- INITIALIZATION --- */
    firebase.initializeApp(CONFIG.firebase);
    const db = firebase.database();

    /* --- UTILITIES CLASS --- */
    class Utils {
        static formatDate(dateStr) {
            if(!dateStr) return '';
            const date = new Date(dateStr);
            const today = new Date();
            const diff = Math.floor((date - today) / (1000 * 60 * 60 * 24));
            
            if (diff === 0) return `<span style="color:var(--danger)">Due Today</span>`;
            if (diff === 1) return `<span style="color:var(--warning)">Tomorrow</span>`;
            if (diff < 0) return `<span style="opacity:0.5">Overdue</span>`;
            return `Due in ${diff} days`;
        }

        static sanitize(str) {
            if(!str) return '';
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').trim();
        }

        static generateId() {
            return Math.random().toString(36).substr(2, 9);
        }
    }

    /* --- TOAST NOTIFICATION SYSTEM --- */
    class Notify {
        static show(msg, type = 'success') {
            const container = document.getElementById('toast-area');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `
                <div style="width:10px; height:10px; border-radius:50%; background:${type==='success'?'#30D158':'#FF453A'}"></div>
                ${msg}
            `;
            container.appendChild(el);
            
            // Auto remove
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(-20px)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        static loading(state) {
            const el = document.getElementById('loader');
            if(state) el.classList.add('show');
            else el.classList.remove('show');
        }
    }

    /* --- ROUTER ENGINE --- */
    class Router {
        static to(viewId, navEl = null) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            // Show target
            document.getElementById('view-' + viewId).classList.add('active');
            
            // Update Dock
            if(navEl) {
                document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
                navEl.classList.add('active');
            } else if (viewId === 'home') {
                // If navigating programmatically to home, update dock manually
                document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
                document.querySelector('.dock-item:first-child').classList.add('active');
            }
        }
    }

    /* --- MODAL MANAGER --- */
    class Modals {
        static open(type) {
            const overlay = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            const actions = document.getElementById('modal-actions');
            
            overlay.classList.add('open');
            title.innerText = ""; content.innerHTML = ""; actions.innerHTML = "";

            switch(type) {
                case 'auth-login':
                    title.innerText = "Welcome Back";
                    content.innerHTML = `
                        <div class="input-group">
                            <input id="in-u" class="inp" placeholder="Username">
                        </div>
                        <div class="input-group">
                            <input id="in-p" type="password" class="inp" placeholder="Password">
                        </div>
                    `;
                    actions.innerHTML = `
                        <button class="btn btn-primary" onclick="Core.login()">Sign In</button>
                        <button class="btn btn-ghost" onclick="Modals.close()">Cancel</button>
                    `;
                    break;

                case 'auth-signup':
                    title.innerText = "Join Enterprise";
                    content.innerHTML = `
                        <div class="input-group">
                            <input id="in-u" class="inp" placeholder="Choose Username (e.g. Admin)">
                        </div>
                        <div class="input-group">
                            <input id="in-p" type="password" class="inp" placeholder="Create Password">
                        </div>
                    `;
                    actions.innerHTML = `
                        <button class="btn btn-primary" onclick="Core.signup()">Create Account</button>
                        <button class="btn btn-ghost" onclick="Modals.close()">Cancel</button>
                    `;
                    break;

                case 'add-subject':
                    title.innerText = "New Table";
                    content.innerHTML = `<input id="sub-name" class="inp" placeholder="Subject Name (e.g. Physics)">`;
                    actions.innerHTML = `
                        <button class="btn btn-primary" onclick="Core.createSubject()">Create Table</button>
                        <button class="btn btn-ghost" onclick="Modals.close()">Cancel</button>
                    `;
                    break;

                case 'add-task':
                    title.innerText = "New Goal";
                    content.innerHTML = `
                        <input id="task-desc" class="inp" placeholder="Goal Description" style="margin-bottom:10px;">
                        <input id="task-date" type="date" class="inp">
                    `;
                    actions.innerHTML = `
                        <button class="btn btn-primary" onclick="Core.createTask()">Add Goal</button>
                        <button class="btn btn-ghost" onclick="Modals.close()">Cancel</button>
                    `;
                    break;
            }
        }

        static close() {
            document.getElementById('modal-overlay').classList.remove('open');
        }
    }

    /* --- CORE LOGIC --- */
    const Core = {
        state: {
            user: localStorage.getItem('ent_user'),
            pass: localStorage.getItem('ent_pass'),
            data: null,
            activeSubIndex: 0,
            viewingUser: null,
            uploadTarget: null
        },

        /* AUTHENTICATION */
        async login() {
            const u = document.getElementById('in-u').value.trim();
            const p = document.getElementById('in-p').value.trim();

            if(!u || !p) return Core.shakeInput();

            Notify.loading(true);
            const ref = db.ref('users/' + u);
            const snap = await ref.once('value');
            Notify.loading(false);

            if(!snap.exists()) {
                Notify.show("User does not exist", "error");
                return;
            }

            const val = snap.val();
            if(val.pass !== p) {
                Notify.show("Incorrect Password", "error");
                return;
            }

            // Success
            localStorage.setItem('ent_user', u);
            localStorage.setItem('ent_pass', p);
            Notify.show("Login Successful");
            setTimeout(() => location.reload(), 1000);
        },

        async signup() {
            const u = document.getElementById('in-u').value.trim();
            const p = document.getElementById('in-p').value.trim();

            if(!u || !p) return Core.shakeInput();

            Notify.loading(true);
            const ref = db.ref('users/' + u);
            const snap = await ref.once('value');

            if(snap.exists()) {
                Notify.loading(false);
                Notify.show("Username taken. Try another.", "error");
                return;
            }

            await ref.set({
                user: u,
                pass: p,
                joined: new Date().toISOString(),
                subjects: [],
                invites: [],
                family: [],
                pfp: "",
                bnr: ""
            });

            Notify.loading(false);
            localStorage.setItem('ent_user', u);
            localStorage.setItem('ent_pass', p);
            Notify.show("Account Created!");
            setTimeout(() => location.reload(), 1000);
        },

        logout() {
            if(confirm("Are you sure you want to log out?")) {
                localStorage.clear();
                location.reload();
            }
        },

        shakeInput() {
            const inputs = document.querySelectorAll('.inp');
            inputs.forEach(i => {
                i.classList.add('shake');
                setTimeout(() => i.classList.remove('shake'), 400);
            });
            Notify.show("Please fill all fields", "error");
        },

        /* DATA MANAGEMENT */
        createSubject() {
            const name = document.getElementById('sub-name').value;
            if(!name) return;

            const subs = Core.state.data.subjects || [];
            subs.push({ name: name, tasks: [], created: Date.now() });

            db.ref('users/' + Core.state.user).update({ subjects: subs })
            .then(() => {
                Modals.close();
                Notify.show("Table Created");
            });
        },

        openSubject(index) {
            Core.state.activeSubIndex = index;
            const sub = Core.state.data.subjects[index];
            
            document.getElementById('detail-title').innerText = sub.name;
            document.getElementById('detail-count').innerText = (sub.tasks || []).length + " Goals";

            const container = document.getElementById('list-tasks');
            if(!sub.tasks || sub.tasks.length === 0) {
                container.innerHTML = `
                    <div class="list-empty">
                        <svg class="icon-svg" style="opacity:0.3; width:40px; height:40px;" viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
                        <span>No goals yet. Add one!</span>
                    </div>`;
            } else {
                container.innerHTML = sub.tasks.map((t, i) => `
                    <div class="card anim-item" style="padding:16px; animation-delay:${i * 0.05}s">
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-weight:600; font-size:16px;">${t.desc}</span>
                        </div>
                        <div style="margin-top:8px; font-size:12px; display:flex; align-items:center; gap:5px;">
                            <svg class="icon-svg" style="width:12px; height:12px; opacity:0.6" viewBox="0 0 24 24"><path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"/></svg>
                            ${Utils.formatDate(t.date)}
                        </div>
                    </div>
                `).join('');
            }
            Router.to('detail');
        },

        createTask() {
            const desc = document.getElementById('task-desc').value;
            const date = document.getElementById('task-date').value;
            if(!desc || !date) return;

            let subs = Core.state.data.subjects;
            subs[Core.state.activeSubIndex].tasks = subs[Core.state.activeSubIndex].tasks || [];
            subs[Core.state.activeSubIndex].tasks.push({ desc, date });

            db.ref('users/' + Core.state.user).update({ subjects: subs })
            .then(() => {
                Modals.close();
                Core.openSubject(Core.state.activeSubIndex); // Refresh view
                Notify.show("Goal Added");
            });
        },

        /* SEARCH & SOCIAL */
        async search(query) {
            const container = document.getElementById('list-search');
            if(!query) { container.innerHTML = ""; return; }

            const snap = await db.ref('users').once('value');
            let results = [];
            
            snap.forEach(child => {
                const u = child.val();
                if(u.user && u.user.toLowerCase().includes(query.toLowerCase())) {
                    results.push(u);
                }
            });

            if(results.length === 0) {
                container.innerHTML = `<div class="list-empty">No users found.</div>`;
                return;
            }

            container.innerHTML = results.map((u, i) => `
                <div class="card anim-item" onclick="Core.viewPublicProfile('${u.user}')" style="animation-delay:${i*0.05}s">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img src="${u.pfp || CONFIG.defaults.pfp + u.user}" style="width:40px; height:40px; border-radius:12px; object-fit:cover;">
                            <div>
                                <b>${u.user}</b><br>
                                <small>${(u.subjects||[]).length} Tables</small>
                            </div>
                        </div>
                        ${Core.state.user && Core.state.user !== u.user ? 
                        `<button class="btn btn-primary" style="width:auto; padding:8px 16px; margin:0; font-size:12px;" onclick="event.stopPropagation(); Core.sendInvite('${u.user}')">INVITE</button>` 
                        : ''}
                    </div>
                </div>
            `).join('');
        },

        async viewPublicProfile(targetUser) {
            Notify.loading(true);
            Core.state.viewingUser = targetUser;
            const snap = await db.ref('users/' + targetUser).once('value');
            Notify.loading(false);

            if(!snap.exists()) return Notify.show("User error", "error");
            const d = snap.val();

            document.getElementById('pub-name').innerText = d.user;
            document.getElementById('pub-bnr').src = d.bnr || CONFIG.defaults.banner;
            document.getElementById('pub-pfp').src = d.pfp || CONFIG.defaults.pfp + d.user;

            const list = document.getElementById('pub-list');
            if(!d.subjects || d.subjects.length === 0) {
                list.innerHTML = `<div class="card" style="opacity:0.5">No public tables.</div>`;
            } else {
                list.innerHTML = d.subjects.map(s => `
                    <div class="card" style="margin-bottom:10px;">
                        <b>${s.name}</b>
                        <div style="font-size:12px; opacity:0.6; margin-top:5px;">${(s.tasks||[]).length} Goals</div>
                    </div>
                `).join('');
            }

            // ADMIN LOGIC CHECK
            const adminPanel = document.getElementById('admin-panel');
            if(Core.state.user === 'Admin' && targetUser !== 'Admin') {
                adminPanel.classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
            }

            Router.to('public');
        },

        async adminDeleteUser() {
            if(!Core.state.viewingUser) return;
            const confirmed = confirm(`CRITICAL WARNING:\n\nYou are about to delete user: ${Core.state.viewingUser}\nThis will erase all their data forever.\n\nProceed?`);
            
            if(confirmed) {
                Notify.loading(true);
                await db.ref('users/' + Core.state.viewingUser).remove();
                Notify.loading(false);
                Notify.show("User Deleted", "success");
                Router.to('search');
            }
        },

        async sendInvite(target) {
            const ref = db.ref('users/'+target+'/invites');
            const snap = await ref.once('value');
            let invites = snap.val() || [];
            
            if(invites.includes(Core.state.user)) {
                Notify.show("Already invited", "warning");
            } else {
                invites.push(Core.state.user);
                await ref.set(invites);
                Notify.show("Invitation Sent");
            }
        },

        async handleInvite(sender, accept) {
            // Remove invitation
            let newInvites = (Core.state.data.invites || []).filter(i => i !== sender);
            
            if(accept) {
                // Add to my family
                let myFam = Core.state.data.family || [];
                if(!myFam.includes(sender)) myFam.push(sender);
                await db.ref('users/'+Core.state.user).update({ family: myFam, invites: newInvites });

                // Add me to sender's family
                const senderRef = db.ref('users/'+sender+'/family');
                const senderSnap = await senderRef.once('value');
                let senderFam = senderSnap.val() || [];
                if(!senderFam.includes(Core.state.user)) senderFam.push(Core.state.user);
                await senderRef.set(senderFam);
                
                Notify.show("Connected with " + sender);
            } else {
                await db.ref('users/'+Core.state.user).update({ invites: newInvites });
                Notify.show("Ignored request");
            }
        },

        /* IMAGE UPLOAD */
        triggerUpload(type) {
            if(!Core.state.user) return Modals.open('auth-signup');
            Core.state.uploadTarget = type;
            document.getElementById('file-hidden').click();
        },

        processUpload(input) {
            if(!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const reader = new FileReader();
            
            // Limit size check (simple)
            if(file.size > 2000000) return Notify.show("Image too large (Max 2MB)", "error");

            Notify.loading(true);
            reader.onload = async (e) => {
                const base64 = e.target.result;
                await db.ref('users/' + Core.state.user).update({
                    [Core.state.uploadTarget]: base64
                });
                Notify.loading(false);
                Notify.show("Image Updated");
            };
            reader.readAsDataURL(file);
        },

        /* INITIALIZATION RENDERER */
        init() {
            if(Core.state.user) {
                // LOGGED IN
                document.getElementById('guest-ctrl').classList.add('hidden');
                document.getElementById('user-ctrl').classList.remove('hidden');

                // Realtime Listener
                db.ref('users/' + Core.state.user).on('value', snap => {
                    const d = snap.val();
                    if(!d) return; // User deleted check
                    Core.state.data = d;

                    // 1. Profile Render
                    document.getElementById('pf-name').innerText = d.user;
                    document.getElementById('pf-bnr').src = d.bnr || CONFIG.defaults.banner;
                    document.getElementById('pf-pfp').src = d.pfp || CONFIG.defaults.pfp + d.user;
                    document.getElementById('stat-tables').innerText = (d.subjects||[]).length;
                    document.getElementById('stat-fam').innerText = (d.family||[]).length;

                    // Role Badge
                    const badgeContainer = document.getElementById('pf-badge-container');
                    if(d.user === 'Admin') {
                        badgeContainer.innerHTML = `<span class="badge badge-admin">ADMINISTRATOR</span>`;
                    } else {
                        badgeContainer.innerHTML = `<span class="badge badge-pro">PRO MEMBER</span>`;
                    }

                    // 2. Subject List Render
                    const subList = document.getElementById('list-subjects');
                    if(!d.subjects || d.subjects.length === 0) {
                        subList.innerHTML = `<div class="list-empty">You have no tables.<br>Create one to start studying.</div>`;
                    } else {
                        subList.innerHTML = d.subjects.map((s, i) => `
                            <div class="card anim-item" onclick="Core.openSubject(${i})" style="animation-delay:${i*0.1}s">
                                <div class="card-header">
                                    <span style="font-weight:700; font-size:18px;">${s.name}</span>
                                    <svg class="icon-svg" style="opacity:0.5" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg>
                                </div>
                                <div style="font-size:13px; opacity:0.6;">${(s.tasks||[]).length} Active Goals</div>
                                <div style="height:4px; background:#333; margin-top:10px; border-radius:2px; overflow:hidden;">
                                    <div style="width:${Math.random() * 100}%; height:100%; background:var(--primary);"></div>
                                </div>
                            </div>
                        `).join('');
                    }

                    // 3. Inbox Render
                    const msgList = document.getElementById('list-msgs');
                    const invites = d.invites || [];
                    const badge = document.getElementById('notif-badge');
                    
                    if(invites.length > 0) {
                        badge.classList.add('show');
                        msgList.innerHTML = invites.map((inv, i) => `
                            <div class="card anim-item" style="animation-delay:${i*0.1}s">
                                <div style="display:flex; gap:12px; align-items:center;">
                                    <div style="width:40px; height:40px; border-radius:12px; background:var(--primary); display:flex; align-items:center; justify-content:center; font-weight:bold;">
                                        ${inv.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <b>${inv}</b>
                                        <div style="font-size:12px; opacity:0.7;">Wants to be family</div>
                                    </div>
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                                    <button class="btn btn-primary" style="margin:0; padding:10px;" onclick="Core.handleInvite('${inv}', true)">Accept</button>
                                    <button class="btn btn-secondary" style="margin:0; padding:10px;" onclick="Core.handleInvite('${inv}', false)">Ignore</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        badge.classList.remove('show');
                        msgList.innerHTML = `<div class="list-empty">No pending invitations.</div>`;
                    }
                });

            } else {
                // GUEST MODE
                document.getElementById('guest-ctrl').classList.remove('hidden');
                document.getElementById('user-ctrl').classList.add('hidden');
                document.getElementById('pf-bnr').src = CONFIG.defaults.banner;
                document.getElementById('pf-pfp').src = 'https://api.dicebear.com/7.x/shapes/svg?seed=Guest';
                document.getElementById('pf-name').innerText = "Guest Visitor";
                document.getElementById('pf-badge-container').innerHTML = `<span class="badge badge-guest">VISITOR MODE</span>`;
                
                document.getElementById('list-subjects').innerHTML = `
                    <div class="card" style="opacity:0.6;">
                        <h3>Welcome to SyllabusStudy</h3>
                        <p class="mt-1">Please log in to manage your tables.</p>
                    </div>`;
            }
        }
    };

    /* --- BOOTSTRAP --- */
    window.onload = () => {
        // Simple entry animation for the main home screen
        setTimeout(() => {
            document.getElementById('view-home').classList.add('active');
        }, 100);
        
        // Start App
        Core.init();
    };

</script>
</body>
</html>
