<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SyllabusStudy V2</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* --- THEME CONFIG --- */
        :root {
            --primary: #2997ff;
            --danger: #ff453a;
            --bg: #000000;
            --card: rgba(28, 28, 30, 0.65);
            --border: rgba(255, 255, 255, 0.12);
            --text: #ffffff;
        }

        /* --- BASE STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; height: 100vh; overflow: hidden; }

        /* --- ANIMATED WALLPAPER --- */
        .wallpaper {
            position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 80% 20%, #1a1a2e, #000 70%),
                        radial-gradient(circle at 20% 80%, #0f1c2e, #000 70%);
            animation: breathe 8s ease-in-out infinite alternate;
        }
        @keyframes breathe { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }

        /* --- SCREEN TRANSITIONS --- */
        .screen {
            position: absolute; inset: 0;
            padding: 85px 24px 130px;
            opacity: 0; pointer-events: none;
            transform: scale(0.96) translateY(15px);
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto; scrollbar-width: none;
        }
        .screen.active { opacity: 1; pointer-events: auto; transform: scale(1) translateY(0); }
        .screen::-webkit-scrollbar { display: none; }

        /* --- CARD & UI ELEMENTS --- */
        .card {
            background: var(--card);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--border);
            border-radius: 24px; padding: 20px;
            margin-bottom: 16px; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }

        .btn {
            width: 100%; padding: 18px; border-radius: 18px; border: none;
            font-size: 16px; font-weight: 700; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn:active { opacity: 0.7; transform: scale(0.98); }
        .btn-primary { background: white; color: black; }
        .btn-glass { background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border); margin-top: 10px; }
        .btn-danger { background: rgba(255, 69, 58, 0.2); color: var(--danger); border: 1px solid var(--danger); margin-top: 10px; }

        .inp {
            width: 100%; padding: 18px; background: rgba(0,0,0,0.4);
            border: 1px solid var(--border); border-radius: 16px;
            color: white; font-size: 16px; margin-bottom: 12px;
            transition: 0.3s;
        }
        .inp:focus { border-color: var(--primary); background: rgba(0,0,0,0.7); }

        /* --- PROFILE ELEMENTS --- */
        .banner-box { height: 160px; border-radius: 24px; overflow: hidden; background: #222; border: 1px solid var(--border); position: relative; }
        .banner-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .pfp-box {
            width: 90px; height: 90px; border-radius: 24px; border: 4px solid #000;
            background: #333; overflow: hidden; margin-top: -45px; margin-left: 20px;
            position: relative; z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .pfp-box img { width: 100%; height: 100%; object-fit: cover; }

        .role-badge { 
            display: inline-block; padding: 5px 10px; border-radius: 8px; 
            font-size: 10px; font-weight: 800; text-transform: uppercase; 
            margin-top: 8px; letter-spacing: 1px; 
        }

        /* --- BOTTOM DOCK --- */
        .dock {
            position: fixed; bottom: 25px; left: 20px; right: 20px; height: 75px;
            background: rgba(22, 22, 24, 0.9); backdrop-filter: blur(40px);
            border-radius: 35px; border: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 900; box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .dock-tab { flex: 1; display: flex; flex-direction: column; align-items: center; opacity: 0.4; transition: 0.3s; cursor: pointer; gap: 4px; }
        .dock-tab.active { opacity: 1; transform: translateY(-4px); }
        .dock-icon { font-size: 24px; }
        .dock-lbl { font-size: 10px; font-weight: 700; }
        
        .dot { width: 8px; height: 8px; background: var(--danger); border-radius: 50%; position: absolute; top: 15px; right: 28%; display: none; }

        /* --- STAGGER ANIMATION --- */
        @keyframes slideIn { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }
        .anim { opacity: 0; animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        /* --- ERROR SHAKE --- */
        @keyframes shake { 0%, 100% {transform: translateX(0);} 20%, 60% {transform: translateX(-5px);} 40%, 80% {transform: translateX(5px);} }
        .shake { animation: shake 0.4s ease; border-color: var(--danger) !important; }

        /* --- MODAL --- */
        .modal-wrap {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-wrap.open { opacity: 1; pointer-events: auto; }
        .modal-card { width: 85%; max-width: 360px; background: #161618; border: 1px solid var(--border); border-radius: 32px; padding: 30px; transform: scale(0.9); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-wrap.open .modal-card { transform: scale(1); }
    </style>
</head>
<body>

    <div class="wallpaper"></div>

    <div id="scr-home" class="screen active">
        <h1>My Tables</h1>
        <div id="list-subs" style="margin-top: 20px;"></div>
        <button class="btn btn-primary" style="margin-top:20px" onclick="GUI.open('new-sub')">+ Create Table</button>
    </div>

    <div id="scr-detail" class="screen">
        <div onclick="UI.nav('home')" style="opacity:0.6; margin-bottom:20px; display:inline-flex; align-items:center; gap:8px;">‚Üê Back</div>
        <h1 id="dt-head" style="margin:0;">Title</h1>
        <p id="dt-sub" style="opacity:0.5; margin-bottom:20px;">0 Goals</p>
        <div id="list-tasks"></div>
        <button class="btn btn-primary" style="margin-top:20px" onclick="GUI.open('new-task')">Add Goal</button>
    </div>

    <div id="scr-search" class="screen">
        <h1>Search</h1>
        <input class="inp" placeholder="Find User..." oninput="Core.search(this.value)">
        <div id="list-search" style="margin-top:20px;"></div>
    </div>

    <div id="scr-msgs" class="screen">
        <h1>Inbox</h1>
        <div id="list-msgs" style="margin-top:20px;"></div>
    </div>

    <div id="scr-profile" class="screen" style="padding-top:0;">
        <div class="banner-box" onclick="Core.tryUp('bnr')"><img id="pf-bnr" src=""></div>
        <div class="pfp-box" onclick="Core.tryUp('pfp')"><img id="pf-pfp" src=""></div>
        
        <div style="padding: 15px;">
            <h1 id="pf-name">Guest</h1>
            <span id="pf-role" class="role-badge" style="background:#333; color:#aaa;">VISITOR</span>

            <div id="menu-guest" style="margin-top:40px;">
                <div class="card">
                    <b>Sync Account</b>
                    <p style="opacity:0.6; font-size:13px; margin-top:5px;">Sign up to secure your tables and use Family features.</p>
                </div>
                <button class="btn btn-primary" onclick="GUI.open('signup')">Sign Up</button>
                <button class="btn btn-glass" onclick="GUI.open('login')">Log In</button>
            </div>

            <div id="menu-user" style="display:none; margin-top:40px;">
                <button class="btn btn-danger" onclick="Core.logout()">Log Out</button>
            </div>
        </div>
    </div>

    <div id="scr-public" class="screen" style="padding-top:0;">
        <div onclick="UI.nav('search')" style="position:absolute; top:20px; left:20px; z-index:50; background:rgba(0,0,0,0.6); padding:8px 16px; border-radius:20px; font-weight:bold; font-size:12px;">‚Üê Return</div>
        <div class="banner-box"><img id="pub-bnr" src=""></div>
        <div class="pfp-box"><img id="pub-pfp" src=""></div>
        <div style="padding: 15px;">
            <h1 id="pub-name">User</h1>
            <div style="margin-top:30px;">
                <h4 style="opacity:0.5; font-size:12px; text-transform:uppercase;">Public Tables</h4>
                <div id="pub-list"></div>
            </div>
            
            <div id="admin-tools" style="display:none; margin-top:40px; border-top:1px solid var(--border); padding-top:20px;">
                <b style="color:var(--danger)">‚ö†Ô∏è ADMIN ZONE</b>
                <p style="opacity:0.6; font-size:13px;">Delete this user from the database?</p>
                <button class="btn btn-danger" onclick="Core.adminDelete()">DELETE USER</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal-wrap">
        <div class="modal-card">
            <h2 id="m-t" style="margin-top:0;">Title</h2>
            <div id="m-c"></div>
            <div id="m-a" style="margin-top:20px;"></div>
        </div>
    </div>

    <input type="file" id="f-up" style="display:none" onchange="Core.doUp(this)">

    <div class="dock">
        <div class="dock-tab active" onclick="UI.nav('home', this)"><span class="dock-icon">üìö</span><span class="dock-lbl">Home</span></div>
        <div class="dock-tab" onclick="UI.nav('search', this)"><span class="dock-icon">üîç</span><span class="dock-lbl">Search</span></div>
        <div class="dock-tab" onclick="UI.nav('msgs', this)">
            <div id="notif" class="dot"></div>
            <span class="dock-icon">üí¨</span><span class="dock-lbl">Inbox</span>
        </div>
        <div class="dock-tab" onclick="UI.nav('profile', this)"><span class="dock-icon">üë§</span><span class="dock-lbl">Profile</span></div>
    </div>

<script>
    // 1. FIREBASE SETUP
    const cfg = { apiKey: "AIzaSyC2ryrcM8eRTUIkBrVitQUWn2x5oTbbnmE", authDomain: "syllabuspro-4ec5c.firebaseapp.com", projectId: "syllabuspro-4ec5c", databaseURL: "https://syllabuspro-4ec5c-default-rtdb.asia-southeast1.firebasedatabase.app/", storageBucket: "syllabuspro-4ec5c.firebasestorage.app" };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    // 2. STATE
    let s = { user: localStorage.getItem('u'), pass: localStorage.getItem('p'), data: null, idx: 0, view: null, upT: null };

    // 3. UI ENGINE
    const UI = {
        nav(id, el) {
            document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
            document.getElementById('scr-'+id).classList.add('active');
            if(el) { document.querySelectorAll('.dock-tab').forEach(x => x.classList.remove('active')); el.classList.add('active'); }
        },
        list(id, arr, fn, empty="Empty") {
            const c = document.getElementById(id);
            if(!arr || !arr.length) { c.innerHTML=`<div style="opacity:0.4; text-align:center; padding:20px;">${empty}</div>`; return; }
            c.innerHTML = arr.map((item, i) => `<div class="anim" style="animation-delay:${i*0.05}s">${fn(item,i)}</div>`).join('');
        }
    };

    // 4. MODAL GUI
    const GUI = {
        open(t) {
            const m=document.getElementById('modal'), h=document.getElementById('m-t'), c=document.getElementById('m-c'), a=document.getElementById('m-a');
            m.classList.add('open'); h.innerText=""; c.innerHTML=""; a.innerHTML="";
            
            if(t==='login'||t==='signup') {
                h.innerText = t==='login'?"Welcome":"New Account";
                c.innerHTML = `<input id="ia" class="inp" placeholder="Username"><input id="ib" type="password" class="inp" placeholder="Password">`;
                a.innerHTML = `<button class="btn btn-primary" onclick="Core.auth('${t}')">Go</button><button class="btn btn-glass" onclick="GUI.close()">Cancel</button>`;
            }
            if(t==='new-sub') {
                if(!s.user) return GUI.open('signup');
                h.innerText="New Table"; c.innerHTML=`<input id="ia" class="inp" placeholder="Subject Name">`;
                a.innerHTML=`<button class="btn btn-primary" onclick="Core.addSub()">Create</button><button class="btn btn-glass" onclick="GUI.close()">Cancel</button>`;
            }
            if(t==='new-task') {
                h.innerText="Add Goal"; c.innerHTML=`<input id="ia" class="inp" placeholder="Desc"><input id="ib" type="date" class="inp">`;
                a.innerHTML=`<button class="btn btn-primary" onclick="Core.addTask()">Add</button><button class="btn btn-glass" onclick="GUI.close()">Cancel</button>`;
            }
        },
        close() { document.getElementById('modal').classList.remove('open'); }
    };

    // 5. CORE LOGIC
    const Core = {
        async auth(mode) {
            // TRIM REMOVES SPACES! Fixes the login bug.
            const u = document.getElementById('ia').value.trim();
            const p = document.getElementById('ib').value.trim();
            
            if(!u || !p) { alert("Fill all fields"); return; }
            
            // Check Database
            const ref = db.ref('users/'+u);
            const snap = await ref.once('value');
            
            if(mode === 'login') {
                if(!snap.exists()) {
                    document.getElementById('ia').classList.add('shake');
                    setTimeout(()=>document.getElementById('ia').classList.remove('shake'), 500);
                    alert("User not found."); 
                    return;
                }
                const val = snap.val();
                if(val.pass !== p) {
                    document.getElementById('ib').classList.add('shake');
                    setTimeout(()=>document.getElementById('ib').classList.remove('shake'), 500);
                    alert("Wrong password.");
                    return;
                }
                // Success
                localStorage.setItem('u', u); localStorage.setItem('p', p);
                location.reload();
            } 
            else {
                // SIGNUP MODE - CHECK DUPLICATE
                if(snap.exists()) {
                    alert("Username '"+u+"' is already taken. Try another.");
                    return;
                }
                // Create
                await ref.set({ user:u, pass:p, subjects:[], invites:[], family:[], pfp:"", bnr:"" });
                localStorage.setItem('u', u); localStorage.setItem('p', p);
                location.reload();
            }
        },
        async search(q) {
            if(!q) return UI.list('list-search',[]);
            const snap = await db.ref('users').once('value');
            let res = [];
            snap.forEach(c => {
                const val = c.val();
                if(val.user && val.user.toLowerCase().includes(q.toLowerCase())) res.push(val);
            });
            UI.list('list-search', res, (u) => `
                <div class="card" onclick="Core.pubView('${u.user}')">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <b>${u.user}</b>
                        ${s.user && s.user!==u.user ? `<button class="role-badge" style="border:none; background:var(--primary); color:#000;" onclick="event.stopPropagation(); Core.invite('${u.user}')">INVITE</button>`:''}
                    </div>
                </div>
            `, "No users found");
        },
        async pubView(target) {
            s.view = target;
            const snap = await db.ref('users/'+target).once('value');
            if(!snap.exists()) return;
            const d = snap.val();
            
            document.getElementById('pub-name').innerText = d.user;
            document.getElementById('pub-bnr').src = d.bnr || 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=800';
            document.getElementById('pub-pfp').src = d.pfp || 'https://api.dicebear.com/7.x/initials/svg?seed='+d.user;
            
            UI.list('pub-list', d.subjects||[], t=>`<div class="card" style="opacity:0.8"><b>${t.name}</b><br><small>${(t.tasks||[]).length} Goals</small></div>`);
            
            // ADMIN CHECK
            if(s.user === 'Admin' && target !== 'Admin') document.getElementById('admin-tools').style.display='block';
            else document.getElementById('admin-tools').style.display='none';
            
            UI.nav('public');
        },
        async adminDelete() {
            if(confirm("ADMIN: Delete "+s.view+" forever?")) {
                await db.ref('users/'+s.view).remove();
                alert("Deleted."); UI.nav('search');
            }
        },
        async invite(who) {
            const r = db.ref('users/'+who+'/invites');
            const sn = await r.once('value');
            let i = sn.val()||[];
            if(!i.includes(s.user)) { i.push(s.user); await r.set(i); alert("Sent"); }
            else alert("Already invited");
        },
        async reply(who, ok) {
            let inv = s.data.invites.filter(x=>x!==who);
            if(ok) {
                let fam = s.data.family||[]; fam.push(who);
                await db.ref('users/'+s.user+'/family').set(fam);
                // Bi-directional
                const r2 = db.ref('users/'+who+'/family');
                const s2 = await r2.once('value');
                let f2 = s2.val()||[]; f2.push(s.user); await r2.set(f2);
            }
            await db.ref('users/'+s.user+'/invites').set(inv);
        },
        tryUp(t) { if(!s.user) return GUI.open('signup'); s.upT=t; document.getElementById('f-up').click(); },
        doUp(el) { const r=new FileReader(); r.onload=async(e)=>{ await db.ref('users/'+s.user).update({[s.upT]:e.target.result}); }; r.readAsDataURL(el.files[0]); },
        addSub() {
            const n=document.getElementById('ia').value;
            let sub = s.data.subjects||[]; sub.push({name:n, tasks:[]});
            db.ref('users/'+s.user+'/subjects').set(sub).then(()=>GUI.close());
        },
        openSub(i) {
            s.idx=i; const t=s.data.subjects[i];
            document.getElementById('dt-head').innerText=t.name;
            document.getElementById('dt-sub').innerText=(t.tasks||[]).length + " Goals";
            UI.list('list-tasks', t.tasks||[], k=>`<div class="card"><b>${k.desc}</b><br><small style="color:var(--primary)">${k.date}</small></div>`);
            UI.nav('detail');
        },
        addTask() {
            const d=document.getElementById('ia').value, dt=document.getElementById('ib').value;
            let sub = s.data.subjects; sub[s.idx].tasks=sub[s.idx].tasks||[];
            sub[s.idx].tasks.push({desc:d, date:dt});
            db.ref('users/'+s.user+'/subjects').set(sub).then(()=>{ GUI.close(); Core.openSub(s.idx); });
        },
        logout() { localStorage.clear(); location.reload(); }
    };

    // 6. INIT
    window.onload = () => {
        if(s.user) {
            document.getElementById('menu-guest').style.display='none';
            document.getElementById('menu-user').style.display='block';
            db.ref('users/'+s.user).on('value', snap => {
                s.data = snap.val();
                if(!s.data) return; // Handle rare case of deleted user
                
                // Profile
                document.getElementById('pf-name').innerText = s.data.user;
                document.getElementById('pf-bnr').src = s.data.bnr || 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=800';
                document.getElementById('pf-pfp').src = s.data.pfp || 'https://api.dicebear.com/7.x/initials/svg?seed='+s.data.user;
                
                if(s.data.user === "Admin") { 
                    const b = document.getElementById('pf-role'); b.innerText="ADMIN"; b.style.background="var(--danger)"; b.style.color="#fff";
                } else {
                    const b = document.getElementById('pf-role'); b.innerText="PRO MEMBER"; b.style.background="var(--primary)"; b.style.color="#000";
                }

                // Tables
                UI.list('list-subs', s.data.subjects||[], (sub,i) => `
                    <div class="card" onclick="Core.openSub(${i})">
                        <b>${sub.name}</b><span style="float:right">‚ûú</span>
                        <div style="font-size:12px; opacity:0.6; margin-top:5px;">${(sub.tasks||[]).length} Goals</div>
                    </div>
                `, "Create a table to start.");

                // Messages
                const inv = s.data.invites||[];
                document.getElementById('notif').style.display = inv.length ? 'block' : 'none';
                UI.list('list-msgs', inv, m => `
                    <div class="card">
                        <b>${m}</b> wants to connect.
                        <div style="margin-top:10px; display:flex; gap:10px;">
                            <button class="btn btn-primary" style="padding:10px;" onclick="Core.reply('${m}',true)">Accept</button>
                            <button class="btn btn-glass" style="margin:0; padding:10px;" onclick="Core.reply('${m}',false)">Deny</button>
                        </div>
                    </div>
                `, "No messages.");
            });
        } else {
            // Guest Defaults
            document.getElementById('pf-bnr').src='https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=800';
            document.getElementById('pf-pfp').src='https://api.dicebear.com/7.x/shapes/svg?seed=Guest';
            UI.list('list-subs', [], null, "Sign in to see tables.");
        }
    };
</script>
</body>
</html>
