<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Syllabus Titan v10</title>
    
    <link rel="manifest" href="manifest.json">

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --surface-1: #050505;
            --surface-2: #0f1115;
            --surface-3: #181b21;
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-red: #ff003c;
            --neon-green: #0aff00;
            --glass-border: rgba(255, 255, 255, 0.08);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--surface-1); color: #e0e0e0; font-family: var(--font-main); overflow: hidden; height: 100vh; }

        /* UTILITIES */
        .h1 { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; margin: 0 0 15px 0; }
        .h2 { font-size: 18px; font-weight: 600; opacity: 0.9; }
        .h3 { font-size: 14px; font-weight: 600; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
        .text-dim { color: #888; font-size: 13px; }
        .text-mono { font-family: 'Courier New', monospace; font-size: 12px; }
        .gradient-text { background: linear-gradient(135deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* COMPONENTS */
        .btn {
            background: var(--surface-3); border: 1px solid var(--glass-border); color: white;
            padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: all 0.2s ease; width: 100%; display: inline-flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--neon-blue); color: #000; border: none; box-shadow: 0 0 15px rgba(0, 243, 255, 0.3); }
        .btn-ghost { background: transparent; border: 1px solid var(--glass-border); }
        .btn-sm { padding: 6px 12px; font-size: 12px; width: auto; }

        .card { background: var(--surface-2); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; margin-bottom: 15px; }
        .card-glass { background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(10px); }
        .card-interactive:active { background: var(--surface-3); }

        .input-field {
            width: 100%; background: var(--surface-1); border: 1px solid var(--glass-border);
            color: white; padding: 12px; border-radius: 8px; font-size: 16px; outline: none;
            transition: border-color 0.3s;
        }
        .input-field:focus { border-color: var(--neon-blue); }

        /* LAYOUTS */
        #boot-terminal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; padding: 20px;
            display: flex; flex-direction: column; justify-content: flex-end;
            font-family: 'Courier New', monospace; color: var(--neon-green);
        }
        
        #app-viewport {
            display: none; height: 100vh; display: flex; flex-direction: column;
            opacity: 0; transition: opacity 0.5s ease;
        }

        .view-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        
        /* NAVBAR */
        .nav-dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 17, 21, 0.85); backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            display: flex; padding: 5px; gap: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 100;
        }
        .nav-item {
            width: 50px; height: 50px; border-radius: 18px; border: none;
            background: transparent; color: #666; font-size: 20px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .nav-item.active { background: var(--surface-3); color: var(--neon-blue); }

        /* CHAT & NOTIFICATIONS */
        #chat-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--surface-1); z-index: 200; transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        #chat-layer.open { transform: translateX(0); }
    </style>
</head>
<body>

    <div id="boot-terminal">
        <div id="term-log"></div>
    </div>

    <div id="app-viewport" style="display:none;">
        <div id="main-view" class="view-container"></div>
        
        <div class="nav-dock">
            <button class="nav-item active" onclick="Router.nav('dashboard')">‚åÇ</button>
            <button class="nav-item" onclick="Router.nav('courses')">üìö</button>
            <button class="nav-item" onclick="Router.nav('family')">‚ö°</button>
            <button class="nav-item" onclick="Router.nav('canvas')">‚úé</button>
        </div>
    </div>

    <div id="chat-layer"></div>

    <script>
        /* --- CONFIGURATION --- */
        // üî¥ REPLACE THIS WITH YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // Initialize Firebase safely
        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else if (typeof firebase === 'undefined') {
            console.error("Firebase SDK not loaded. Check internet connection.");
        }

        /* --- MODULE: DATA KERNEL --- */
        class DataKernel {
            constructor() {
                this.db = typeof firebase !== 'undefined' ? firebase.database() : null;
                this.uid = localStorage.getItem('titan_uid') || null;
                this.mode = this.uid ? 'online' : 'guest';
            }

            async login(email, pass) {
                // Simplified Login Simulation for V10
                // In production, use firebase.auth().signInWithEmailAndPassword
                // Here we just mock a user ID for the study group
                if(email && pass) {
                    // Create a deterministic ID based on username for search capability
                    const mockUid = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
                    this.uid = mockUid;
                    localStorage.setItem('titan_uid', mockUid);
                    
                    // Register Username in public index (for Search)
                    if(this.db) {
                        this.db.ref('usernames/' + mockUid).set(mockUid);
                    }
                    
                    window.location.reload();
                }
            }

            logout() {
                localStorage.removeItem('titan_uid');
                window.location.reload();
            }

            // Generic Data Fetcher
            async get(path) {
                if(this.mode === 'guest') {
                    return JSON.parse(localStorage.getItem(path) || 'null');
                }
                const snap = await this.db.ref(`users/${this.uid}/${path}`).once('value');
                return snap.val();
            }

            // Generic Data Setter
            async set(path, data) {
                if(this.mode === 'guest') {
                    localStorage.setItem(path, JSON.stringify(data));
                    return;
                }
                await this.db.ref(`users/${this.uid}/${path}`).set(data);
            }
        }

        const Kernel = new DataKernel();

        /* --- MODULE: SOCIAL ENGINE --- */
        const Social = {
            activeChat: null,
            listener: null,

            async searchUsers(query) {
                if(Kernel.mode === 'guest') return [];
                const snap = await Kernel.db.ref('usernames').limitToFirst(20).once('value');
                const results = [];
                snap.forEach(c => {
                    if(c.key.toLowerCase().includes(query.toLowerCase())) results.push({ user: c.key, uid: c.val() });
                });
                return results;
            },

            async openChat(targetUid, targetName) {
                const chatLayer = document.getElementById('chat-layer');
                chatLayer.innerHTML = `
                    <div style="padding:15px; background:var(--surface-2); border-bottom:1px solid var(--glass-border); display:flex; justify-content:space-between; align-items:center;">
                        <button class="btn btn-ghost btn-sm" onclick="Social.closeChat()">‚Üê Back</button>
                        <span class="h3">${targetName}</span>
                        <div style="width:30px;"></div>
                    </div>
                    <div id="chat-feed" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px;">
                        <div class="spinner" style="margin:auto"></div>
                    </div>
                    <div style="padding:15px; background:var(--surface-1); border-top:1px solid var(--glass-border); display:flex; gap:10px;">
                        <input id="chat-msg" class="input-field" placeholder="Type message..." style="height:45px;">
                        <button class="btn btn-primary" style="width:50px; height:45px;" onclick="Social.send()">‚û§</button>
                    </div>
                `;
                chatLayer.classList.add('open');
                this.activeChat = targetUid;

                const myUid = Kernel.uid;
                const chatId = [myUid, targetUid].sort().join('_');

                const feed = document.getElementById('chat-feed');
                this.listener = Kernel.db.ref(`chats/${chatId}`).limitToLast(50);
                
                this.listener.on('value', (snap) => {
                    feed.innerHTML = '';
                    if(!snap.exists()) {
                        feed.innerHTML = '<div style="margin:auto; opacity:0.5">Secure Channel Open.<br>Start messaging.</div>';
                        return;
                    }
                    const msgs = [];
                    snap.forEach(s => msgs.push(s.val()));
                    msgs.forEach(m => {
                        const isMe = m.sender === myUid;
                        const bubble = document.createElement('div');
                        bubble.style.cssText = `
                            max-width: 75%; padding: 10px 16px; border-radius: 20px; font-size: 15px;
                            align-self: ${isMe ? 'flex-end' : 'flex-start'};
                            background: ${isMe ? 'var(--neon-blue)' : 'var(--surface-3)'};
                            color: ${isMe ? 'white' : '#ccc'};
                            border-bottom-${isMe ? 'right' : 'left'}-radius: 4px;
                        `;
                        bubble.innerText = m.text;
                        feed.appendChild(bubble);
                    });
                    feed.scrollTop = feed.scrollHeight;
                });
            },

            send() {
                const inp = document.getElementById('chat-msg');
                const txt = inp.value.trim();
                if(!txt || !this.activeChat) return;
                const chatId = [Kernel.uid, this.activeChat].sort().join('_');
                Kernel.db.ref(`chats/${chatId}`).push({ sender: Kernel.uid, text: txt, ts: Date.now() });
                inp.value = '';
            },

            closeChat() {
                document.getElementById('chat-layer').classList.remove('open');
                if(this.listener) this.listener.off();
                this.activeChat = null;
            }
        };

        /* --- MODULE: WHITEBOARD ENGINE --- */
        const Whiteboard = {
            canvas: null, ctx: null, isDrawing: false, color: '#00f3ff',
            init() {
                setTimeout(() => {
                    this.canvas = document.getElementById('wb-canvas');
                    if(!this.canvas) return;
                    this.ctx = this.canvas.getContext('2d');
                    this.resize();
                    const events = ['mousedown', 'mousemove', 'mouseup', 'touchstart', 'touchmove', 'touchend'];
                    events.forEach(e => this.canvas.addEventListener(e, (evt) => this.handle(evt), {passive: false}));
                    window.addEventListener('resize', () => this.resize());
                }, 100);
            },
            resize() {
                if(!this.canvas) return;
                const parent = this.canvas.parentElement;
                this.canvas.width = parent.clientWidth;
                this.canvas.height = parent.clientHeight;
                this.ctx.lineWidth = 3; this.ctx.lineCap = 'round'; this.ctx.strokeStyle = this.color;
            },
            handle(e) {
                if(!this.canvas) return;
                e.preventDefault();
                const rect = this.canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const x = clientX - rect.left;
                const y = clientY - rect.top;

                if (e.type === 'mousedown' || e.type === 'touchstart') {
                    this.isDrawing = true; this.ctx.beginPath(); this.ctx.moveTo(x, y);
                } else if (e.type === 'mouseup' || e.type === 'touchend') {
                    this.isDrawing = false;
                } else if (this.isDrawing) {
                    this.ctx.lineTo(x, y); this.ctx.stroke();
                }
            },
            setColor(c) { this.color = c; if(this.ctx) this.ctx.strokeStyle = c; },
            wipe() { if(this.ctx) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); }
        };

        /* --- VIEWS --- */
        const Views = {
            dashboard: async () => {
                const user = Kernel.uid || "GUEST";
                const isGuest = Kernel.mode === 'guest';
                
                return `
                    <h1 class="h1 gradient-text">Command Center</h1>
                    
                    ${isGuest ? `
                    <div class="card card-glass" style="border-color:var(--neon-red);">
                        <h3 class="h3" style="color:var(--neon-red)">‚ö† OFFLINE MODE</h3>
                        <p class="text-dim">Data is saved locally. Login to sync with squad.</p>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input id="login-id" class="input-field" placeholder="Username (e.g. agent007)">
                            <button class="btn btn-primary" onclick="Kernel.login(document.getElementById('login-id').value, 'nopass')">LOGIN</button>
                        </div>
                    </div>` : `
                    <div class="card card-glass">
                        <div style="display:flex; justify-content:space-between;">
                            <span class="h3" style="color:var(--neon-green)">‚óè ONLINE</span>
                            <span class="text-mono">ID: ${user.toUpperCase()}</span>
                        </div>
                        <button class="btn btn-ghost btn-sm" style="margin-top:10px;" onclick="Kernel.logout()">LOGOUT</button>
                    </div>`}

                    <div class="card">
                        <span class="h3">System Stats</span>
                        <div style="display:flex; justify-content:space-between; margin-top:15px;">
                            <div style="text-align:center">
                                <div class="h1" style="color:var(--neon-blue)">0</div>
                                <div class="text-mono">TASKS</div>
                            </div>
                            <div style="text-align:center">
                                <div class="h1" style="color:var(--neon-purple)">0</div>
                                <div class="text-mono">COURSES</div>
                            </div>
                            <div style="text-align:center">
                                <div class="h1" style="color:white">100%</div>
                                <div class="text-mono">HEALTH</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            courses: async () => {
                // Simplified for brevity - expandable
                return `
                    <h1 class="h1 gradient-text">Subject Database</h1>
                    <div class="card card-glass">
                        <p class="text-dim">No subjects loaded in database.</p>
                        <button class="btn btn-primary">Ôºã New Subject</button>
                    </div>
                `;
            },

            family: async () => {
                if(Kernel.mode === 'guest') {
                    return `<div style="text-align:center; padding-top:50px;"><h2 class="h2" style="color:var(--neon-red)">OFFLINE</h2><p class="text-dim">Login required for network access.</p></div>`;
                }
                return `
                    <h1 class="h1 gradient-text">Network</h1>
                    <div class="card card-glass">
                        <span class="text-mono">USER SEARCH</span>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input id="search-u" class="input-field" placeholder="Find agent...">
                            <button class="btn btn-primary" style="width:auto" onclick="window.renderSearch()">Scan</button>
                        </div>
                        <div id="search-res" style="margin-top:15px; display:flex; flex-direction:column; gap:8px;"></div>
                    </div>
                `;
            },

            canvas: async () => {
                setTimeout(() => Whiteboard.init(), 50);
                return `
                    <div style="height:100%; display:flex; flex-direction:column;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h1 class="h1 gradient-text" style="margin:0">Canvas</h1>
                            <div style="display:flex; gap:5px;">
                                <div onclick="Whiteboard.setColor('#00f3ff')" style="width:20px; height:20px; background:var(--neon-blue); border-radius:50%; border:1px solid white; cursor:pointer;"></div>
                                <div onclick="Whiteboard.setColor('#ff003c')" style="width:20px; height:20px; background:var(--neon-red); border-radius:50%; border:1px solid white; cursor:pointer;"></div>
                                <div onclick="Whiteboard.setColor('#ffffff')" style="width:20px; height:20px; background:white; border-radius:50%; border:1px solid white; cursor:pointer;"></div>
                            </div>
                        </div>
                        <div class="card card-glass" style="flex:1; padding:0; overflow:hidden; position:relative; touch-action:none;">
                            <canvas id="wb-canvas" style="width:100%; height:100%; display:block;"></canvas>
                            <button class="btn btn-ghost" onclick="Whiteboard.wipe()" style="position:absolute; bottom:15px; right:15px; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); border:1px solid var(--neon-red); color:var(--neon-red);">‚úñ CLEAR</button>
                        </div>
                    </div>
                `;
            }
        };

        // Helper for Search View
        window.renderSearch = async () => {
            const q = document.getElementById('search-u').value;
            if(!q) return;
            const res = await Social.searchUsers(q);
            const box = document.getElementById('search-res');
            box.innerHTML = res.length ? '' : '<span class="text-dim">No targets found.</span>';
            
            res.forEach(r => {
                if(r.uid === Kernel.uid) return;
                const el = document.createElement('div');
                el.className = 'card card-interactive';
                el.style.marginBottom = '0'; el.style.padding = '10px';
                el.style.display = 'flex'; el.style.justifyContent = 'space-between'; el.style.alignItems = 'center';
                el.innerHTML = '<b>' + r.user + '</b><span class="text-mono" style="color:var(--neon-green)">CONNECT</span>';
                el.onclick = () => Social.openChat(r.uid, r.user);
                box.appendChild(el);
            });
        };

        /* --- ROUTER & UI --- */
        const Router = {
            async nav(viewName) {
                const main = document.getElementById('main-view');
                main.innerHTML = '<div class="spinner"></div>';
                
                // Update active tab style
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                const btnIndex = ['dashboard','courses','family','canvas'].indexOf(viewName);
                if(btnIndex > -1) document.querySelectorAll('.nav-item')[btnIndex].classList.add('active');

                // Render
                if(Views[viewName]) {
                    main.innerHTML = await Views[viewName]();
                }
            }
        };

        /* --- BOOT SEQUENCE --- */
        const BootLoader = {
            init() {
                const term = document.getElementById('term-log');
                const log = (txt) => { term.innerHTML += `> ${txt}<br>`; };
                
                log("INIT_KERNEL_V10...");
                setTimeout(() => log("LOADING_MODULES... OK"), 300);
                setTimeout(() => log("CONNECTING_DB... " + (Kernel.db ? "SECURE" : "OFFLINE")), 800);
                setTimeout(() => {
                    document.getElementById('boot-terminal').style.display = 'none';
                    const app = document.getElementById('app-viewport');
                    app.style.display = 'flex';
                    setTimeout(() => app.style.opacity = 1, 50);
                    Router.nav('dashboard');
                }, 1500);
            }
        };

        // START APP
        window.onload = () => BootLoader.init();

    </script>
</body>
</html>
