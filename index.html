<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Syllabus Titan v6.0 Colossus</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* * ==========================================================================
         * PART 1: CORE VARIABLES & RESET
         * ==========================================================================
         */
        :root {
            /* * COLOR PALETTE: Cyber Dark 
             * Designed for OLED screens and deep contrast.
             */
            --c-bg: #050505;
            --c-surface: rgba(28, 28, 30, 0.65);
            --c-surface-solid: #1c1c1e;
            --c-surface-light: rgba(44, 44, 46, 0.8);
            
            --c-primary: #2d7af1;
            --c-primary-dark: #1a5bbd;
            --c-primary-glow: rgba(45, 122, 241, 0.4);
            
            --c-accent: #bf5af2;
            --c-accent-glow: rgba(191, 90, 242, 0.4);
            
            --c-success: #32d74b;
            --c-danger: #ff453a;
            --c-warn: #ffd60a;
            
            --c-text-main: #ffffff;
            --c-text-sec: rgba(255, 255, 255, 0.55);
            --c-text-ter: rgba(255, 255, 255, 0.3);
            
            /* * METRICS & SPACING 
             */
            --radius-xl: 32px;
            --radius-l: 20px;
            --radius-m: 14px;
            --radius-s: 8px;
            
            --padding-page: 24px;
            --header-h: 180px;
            --avatar-size: 90px;
            --dock-height: 80px;
            
            /* * ANIMATION TIMINGS 
             */
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --ease-expo: cubic-bezier(0.19, 1, 0.22, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --anim-dur-fast: 0.2s;
            --anim-dur-norm: 0.4s;
            --anim-dur-slow: 0.8s;
        }

        /* * GLOBAL RESET 
         */
        *, *::before, *::after { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            user-select: none; 
        }

        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background: var(--c-bg); 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            color: var(--c-text-main); 
            -webkit-font-smoothing: antialiased;
        }

        /* * ==========================================================================
         * PART 2: ANIMATED BACKGROUND ENGINE
         * ==========================================================================
         */
        .live-background {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -1;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #1a0b2e);
            background-size: 400% 400%;
            animation: gradientMove 15s ease infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* * ==========================================================================
         * PART 3: LAYOUT & CONTAINERS
         * ==========================================================================
         */
        #app-root { 
            position: relative; 
            width: 100%; 
            height: 100%; 
        }
        
        .screen {
            position: absolute; 
            inset: 0; 
            padding: var(--padding-page); 
            padding-bottom: 120px; /* Space for Dock */
            overflow-y: auto; 
            scrollbar-width: none;
            opacity: 0; 
            pointer-events: none; 
            transform: scale(0.96) translateY(10px);
            transition: 
                opacity var(--anim-dur-norm) var(--ease-expo), 
                transform var(--anim-dur-norm) var(--ease-expo);
        }
        
        .screen::-webkit-scrollbar { display: none; }
        
        .screen.active { 
            opacity: 1; 
            pointer-events: auto; 
            transform: scale(1) translateY(0); 
        }

        /* * TYPOGRAPHY SYSTEM 
         */
        h1 { font-size: 34px; font-weight: 800; margin: 0 0 8px 0; letter-spacing: -1px; }
        h2 { font-size: 22px; font-weight: 700; margin: 0 0 16px 0; }
        h3 { font-size: 18px; font-weight: 600; margin: 0 0 8px 0; }
        p { font-size: 16px; color: var(--c-text-sec); line-height: 1.5; margin: 0; }
        
        .subtext { 
            font-size: 13px; 
            color: var(--c-text-sec); 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 8px; 
            display: block; 
        }

        /* * COMPONENT: CARDS (Glassmorphism) 
         */
        .card {
            background: var(--c-surface);
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-l);
            padding: 20px; 
            margin-bottom: 16px;
            position: relative; 
            overflow: hidden;
            transition: transform 0.2s, background 0.2s;
        }
        
        .card.interactive:active { 
            transform: scale(0.98); 
            background: rgba(255,255,255,0.15); 
        }
        
        .card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-icon {
            width: 40px; 
            height: 40px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        /* * COMPONENT: BUTTONS 
         */
        .btn {
            width: 100%; 
            height: 56px; 
            border: none; 
            border-radius: var(--radius-m);
            font-size: 17px; 
            font-weight: 600; 
            font-family: inherit; 
            color: #fff;
            background: rgba(255,255,255,0.1); 
            margin-top: 12px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            cursor: pointer; 
            position: relative; 
            overflow: hidden;
            transition: transform 0.2s;
        }
        
        .btn-primary { 
            background: var(--c-primary); 
            box-shadow: 0 8px 20px -6px var(--c-primary-glow); 
        }
        
        .btn-danger { 
            background: rgba(255, 69, 58, 0.15); 
            color: var(--c-danger); 
        }
        
        .btn:active { 
            transform: scale(0.97); 
            opacity: 0.9; 
        }
        
        .btn-sm {
            height: 36px;
            font-size: 14px;
            width: auto;
            padding: 0 16px;
            margin: 0;
        }

        /* * COMPONENT: INPUTS 
         */
        .inp-wrap { margin-bottom: 16px; }
        
        .inp {
            width: 100%; 
            height: 54px; 
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: var(--radius-m);
            padding: 0 16px; 
            color: white; 
            font-size: 16px; 
            font-family: inherit;
            transition: 0.3s;
        }
        
        .inp:focus { 
            border-color: var(--c-primary); 
            box-shadow: 0 0 0 3px var(--c-primary-glow); 
            background: rgba(0,0,0,0.5); 
        }
        
        .inp:disabled {
            opacity: 0.5;
            background: rgba(0,0,0,0.2);
            cursor: not-allowed;
            border-style: dashed;
        }

        /* * ==========================================================================
         * PART 4: SPECIFIC MODULES (Profile, Dock, Chat)
         * ==========================================================================
         */

        /* Profile Hero */
        .profile-hero {
            position: relative;
            width: 100%;
            height: calc(var(--header-h) + (var(--avatar-size) / 2));
            margin-bottom: 20px;
        }
        
        .profile-banner {
            width: 100%; 
            height: var(--header-h);
            background: #222; 
            border-radius: var(--radius-l);
            overflow: hidden; 
            position: relative;
        }
        
        .profile-banner img { width: 100%; height: 100%; object-fit: cover; }
        
        .profile-avatar {
            width: var(--avatar-size); 
            height: var(--avatar-size);
            border-radius: 30px;
            background: #333;
            border: 4px solid var(--c-bg);
            position: absolute;
            left: 24px;
            bottom: 0;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* Navigation Dock */
        .dock-container {
            position: fixed; 
            bottom: 30px; 
            left: 0; 
            width: 100%;
            display: flex; 
            justify-content: center; 
            z-index: 100;
            pointer-events: none;
        }
        
        .dock {
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 24px; 
            border-radius: 40px;
            display: flex; 
            gap: 32px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            pointer-events: auto;
            transform: translateY(0); 
            transition: 0.4s var(--ease-elastic);
        }
        
        .dock.hidden { transform: translateY(150px); }

        .dock-btn {
            position: relative; 
            width: 44px; 
            height: 44px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            color: var(--c-text-sec); 
            transition: 0.3s;
        }
        
        .dock-btn svg { width: 26px; height: 26px; fill: currentColor; }
        
        .dock-btn.active { 
            color: var(--c-primary); 
            transform: translateY(-5px); 
        }
        
        .dock-btn.active::after {
            content:''; 
            position: absolute; 
            bottom: -8px; 
            width: 4px; 
            height: 4px;
            background: var(--c-primary); 
            border-radius: 50%;
            box-shadow: 0 0 10px var(--c-primary);
        }

        /* * CHAT SYSTEM STYLES 
         */
        #chat-interface {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            top: 0; left: 0; width: 100%;
            background: var(--c-bg);
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s var(--ease-expo);
        }
        
        #chat-interface.open { transform: translateX(0); }

        .chat-header {
            height: 80px;
            padding: 20px;
            padding-top: 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(20,20,20,0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-footer {
            padding: 15px;
            padding-bottom: 30px;
            background: rgba(20,20,20,0.9);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 10px;
        }

        .msg {
            max-width: 75%;
            padding: 12px 18px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            animation: popIn 0.3s var(--ease-elastic);
        }
        
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .msg.me {
            align-self: flex-end;
            background: var(--c-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .msg.other {
            align-self: flex-start;
            background: var(--c-surface-light);
            color: white;
            border-bottom-left-radius: 4px;
        }
        
        .msg-time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 4px;
            display: block;
            text-align: right;
        }

        /* * ==========================================================================
         * PART 5: NOTIFICATIONS & MODALS
         * ==========================================================================
         */
        #toast-zone {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            padding: 20px;
            pointer-events: none; 
            z-index: 2000; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            align-items: center;
        }
        
        .toast {
            background: rgba(30,30,30,0.95); 
            backdrop-filter: blur(10px);
            padding: 12px 24px; 
            border-radius: 30px; 
            border: 1px solid rgba(255,255,255,0.1);
            color: white; 
            font-size: 14px; 
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideDown 0.4s var(--ease-elastic);
        }
        
        @keyframes slideDown { 
            from { transform: translateY(-100%); opacity:0; } 
            to { transform: translateY(0); opacity:1; } 
        }

        .modal-overlay {
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(5px);
            z-index: 1500; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            opacity: 0; 
            pointer-events: none; 
            transition: 0.3s;
        }
        
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            width: 85%; 
            max-width: 400px; 
            background: #1c1c1e;
            border-radius: 28px; 
            padding: 24px; 
            border: 1px solid rgba(255,255,255,0.1);
            transform: scale(0.9); 
            transition: 0.3s var(--ease-elastic);
        }
        
        .modal-overlay.open .modal-box { transform: scale(1); }

        /* Intro Sequence */
        #intro-layer {
            position: fixed; 
            inset: 0; 
            background: #000; 
            z-index: 9999;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column;
            transition: opacity 0.8s ease, visibility 0.8s;
        }
        
        .intro-logo {
            width: 80px; 
            height: 80px; 
            background: linear-gradient(135deg, var(--c-primary), var(--c-accent));
            border-radius: 24px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 0 50px var(--c-primary-glow);
            animation: introBounce 1.2s var(--ease-elastic) forwards;
        }
        
        .intro-text {
            margin-top: 20px; 
            font-size: 24px; 
            font-weight: 700; 
            letter-spacing: -0.5px;
            opacity: 0; 
            animation: fadeUp 0.8s 0.5s forwards;
        }
        
        @keyframes introBounce { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Helpers */
        .hidden { display: none !important; }
        .back-nav { display: inline-flex; align-items: center; gap: 8px; font-weight: 600; opacity: 0.7; margin-bottom: 20px; cursor: pointer; }
        
        /* List Animation Staggering */
        .list-anim > * { animation: fadeUpList 0.5s backwards; }
        .list-anim > *:nth-child(1) { animation-delay: 0.05s; }
        .list-anim > *:nth-child(2) { animation-delay: 0.1s; }
        .list-anim > *:nth-child(3) { animation-delay: 0.15s; }
        .list-anim > *:nth-child(4) { animation-delay: 0.2s; }
        .list-anim > *:nth-child(5) { animation-delay: 0.25s; }
        @keyframes fadeUpList { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div class="live-background"></div>
    
    <div id="intro-layer">
        <div class="intro-logo">
            <svg style="width:40px; fill:white;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
        </div>
        <div class="intro-text">TITAN COLOSSUS</div>
    </div>

    <div id="app-root"></div>

    <div id="toast-zone"></div>

    <div class="dock-container">
        <div id="main-dock" class="dock">
            </div>
    </div>

    <div id="chat-interface">
        <div class="chat-header">
            <div onclick="Chat.close()" style="padding:10px; margin-left:-10px; cursor:pointer;">
                <svg viewBox="0 0 24 24" style="width:24px; fill:white"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </div>
            <div style="flex:1; text-align:center; font-weight:700; font-size:18px;" id="chat-title">
                Chat
            </div>
            <div style="width:24px;"></div> </div>
        <div class="chat-body" id="chat-messages">
            </div>
        <div class="chat-footer">
            <input id="chat-inp" class="inp" placeholder="Type a message..." style="height:44px; border-radius:22px;">
            <button class="btn btn-primary" onclick="Chat.send()" style="width:50px; height:44px; margin:0; border-radius:22px;">
                <svg viewBox="0 0 24 24" style="width:20px; fill:white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <div id="modal-base" class="modal-overlay">
        <div class="modal-box">
            <h2 id="m-title">Title</h2>
            <div id="m-body"></div>
            <div style="display:flex; gap:12px; margin-top:24px;">
                <button id="m-btn-p" class="btn btn-primary">Confirm</button>
                <button id="m-btn-s" class="btn">Cancel</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-helper" hidden accept="image/*">

<script>
/**
 * ============================================================================
 * SYLLABUS TITAN v6.0 - THE COLOSSUS ENGINE
 * A production-grade, single-file JS Framework.
 * ============================================================================
 */

/* * ----------------------------------------------------------------------------
 * MODULE 1: CONSTANTS & ASSETS
 * ----------------------------------------------------------------------------
 */
const CONFIG = {
    firebase: {
        apiKey: "AIzaSyC2ryrcM8eRTUIkBrVitQUWn2x5oTbbnmE", // Demo Key
        projectId: "syllabuspro-4ec5c",
        databaseURL: "https://syllabuspro-4ec5c-default-rtdb.asia-southeast1.firebasedatabase.app/"
    },
    assets: {
        defPfp: 'https://api.dicebear.com/7.x/initials/svg?seed=',
        defBanner: 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=800&q=80',
        emptyChat: 'https://via.placeholder.com/400x300?text=No+Messages'
    }
};

const ICONS = {
    home: `<svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`,
    search: `<svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>`,
    profile: `<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`,
    settings: `<svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.56-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>`,
    back: `<svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>`,
    family: `<svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>`,
    chat: `<svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>`
};

/* * ----------------------------------------------------------------------------
 * MODULE 2: DATA ENGINE (Hybrid Cloud/Local)
 * ----------------------------------------------------------------------------
 */
class DataEngine {
    constructor() {
        firebase.initializeApp(CONFIG.firebase);
        this.db = firebase.database();
        this.localKey = 'syll_titan_v6';
        this.mode = 'guest'; 
        this.user = null; 
        
        // Initial Local Load
        this.cache = this._loadLocal();
    }

    /**
     * Loads data from LocalStorage for persistence in Guest Mode.
     */
    _loadLocal() {
        try {
            const raw = localStorage.getItem(this.localKey);
            return raw ? JSON.parse(raw) : this._getEmptySchema();
        } catch (e) {
            console.error("Local Load Failed", e);
            return this._getEmptySchema();
        }
    }

    _getEmptySchema() {
        return { subjects: [], family: [], invites: [], pfp: null, bnr: null };
    }

    _saveLocal() {
        localStorage.setItem(this.localKey, JSON.stringify(this.cache));
    }

    /**
     * Authentication: Login
     * Connects to Firebase and starts Realtime Listeners.
     */
    async login(u, p) {
        const snap = await this.db.ref('users/' + u).once('value');
        if (!snap.exists()) throw new Error("User not found");
        if (snap.val().pass !== p) throw new Error("Wrong password");
        
        this.mode = 'cloud';
        this.user = u;
        
        // Start Data Listener
        this.db.ref('users/' + u).on('value', s => {
            this.cache = s.val() || this._getEmptySchema();
            App.render(); 
        });
        
        return true;
    }

    /**
     * Authentication: Signup
     * Creates new record and migrates local data.
     */
    async signup(u, p) {
        const ref = this.db.ref('users/' + u);
        const snap = await ref.once('value');
        if (snap.exists()) throw new Error("Username taken");
        
        const payload = { ...this.cache, user: u, pass: p, joined: Date.now() };
        await ref.set(payload);
        return this.login(u, p);
    }

    logout() {
        if(this.mode === 'cloud') {
            this.db.ref('users/' + this.user).off();
        }
        this.mode = 'guest';
        this.user = null;
        this.cache = this._loadLocal(); 
        App.router.go('home');
        App.toast("Logged Out");
    }

    /**
     * Universal Save Function.
     * Handles divergence between Guest (Local) and User (Cloud).
     */
    save(path, value) {
        if(path === 'root') this.cache = value;
        else this.cache[path] = value;

        if (this.mode === 'guest') {
            this._saveLocal();
            App.render();
        } else {
            this.db.ref('users/' + this.user).update(this.cache);
        }
    }

    /* --- CLOUD OPERATIONS --- */
    
    async searchUsers(query) {
        if(this.mode === 'guest') return [];
        const snap = await this.db.ref('users').once('value');
        const results = [];
        snap.forEach(c => {
            const val = c.val();
            // Safety Check
            if(val && val.user && typeof val.user === 'string' && val.user.toLowerCase().includes(query.toLowerCase())) {
                results.push(val);
            }
        });
        return results;
    }

    async getPublicProfile(username) {
        const snap = await this.db.ref('users/' + username).once('value');
        return snap.exists() ? snap.val() : null;
    }

    async sendInvite(target) {
        if(this.mode === 'guest') throw new Error("Sign in to use family features");
        if(target === this.user) throw new Error("Cannot invite self");
        
        const ref = this.db.ref('users/' + target + '/invites');
        const snap = await ref.once('value');
        const list = snap.val() || [];
        
        if(list.includes(this.user)) throw new Error("Already invited");
        
        list.push(this.user);
        await ref.set(list);
    }
}

/* * ----------------------------------------------------------------------------
 * MODULE 3: CHAT MANAGER (Real-Time)
 * ----------------------------------------------------------------------------
 */
class ChatManager {
    constructor() {
        this.activeChatId = null;
        this.listener = null;
    }

    /**
     * Generates a unique Chat ID based on two usernames.
     * Sorts alphabetically so "A chat B" is same ID as "B chat A".
     */
    getChatId(userA, userB) {
        return [userA, userB].sort().join('_');
    }

    /**
     * Opens a chat room.
     */
    open(otherUser) {
        if(Engine.mode === 'guest') {
            App.toast("Guests cannot use Chat");
            Modals.open('guestLock');
            return;
        }

        const chatId = this.getChatId(Engine.user, otherUser);
        this.activeChatId = chatId;
        
        // UI Setup
        document.getElementById('chat-title').innerText = otherUser;
        document.getElementById('chat-interface').classList.add('open');
        document.getElementById('chat-messages').innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5">Loading secure channel...</div>';

        // Firebase Listener
        const chatRef = Engine.db.ref('chats/' + chatId);
        this.listener = chatRef.limitToLast(50).on('value', snapshot => {
            const msgs = [];
            snapshot.forEach(c => msgs.push(c.val()));
            this.renderMessages(msgs);
        });
    }

    close() {
        document.getElementById('chat-interface').classList.remove('open');
        if(this.activeChatId && this.listener) {
            Engine.db.ref('chats/' + this.activeChatId).off();
        }
        this.activeChatId = null;
    }

    send() {
        if(!this.activeChatId) return;
        const inp = document.getElementById('chat-inp');
        const txt = inp.value.trim();
        if(!txt) return;

        const msgPayload = {
            sender: Engine.user,
            text: txt,
            ts: Date.now()
        };

        Engine.db.ref('chats/' + this.activeChatId).push(msgPayload);
        inp.value = '';
    }

    renderMessages(msgs) {
        const container = document.getElementById('chat-messages');
        if(msgs.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:50px; opacity:0.5;">No messages yet.<br>Say hello!</div>';
            return;
        }

        let html = '';
        msgs.forEach(m => {
            const isMe = m.sender === Engine.user;
            const date = new Date(m.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            html += `
                <div class="msg ${isMe ? 'me' : 'other'}">
                    ${m.text}
                    <span class="msg-time">${date}</span>
                </div>
            `;
        });
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
    }
}

/* * ----------------------------------------------------------------------------
 * MODULE 4: ROUTER & UI FRAMEWORK
 * ----------------------------------------------------------------------------
 */
class Router {
    constructor() {
        this.routes = {};
        this.history = [];
        this.current = null;
    }
    
    register(name, renderer) { this.routes[name] = renderer; }
    
    go(name, params = null) {
        this.history.push(name);
        this.current = name;
        
        // Screen Transition Logic
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        
        let el = document.getElementById('view-' + name);
        if(!el) {
            el = document.createElement('div');
            el.id = 'view-' + name;
            el.className = 'screen';
            document.getElementById('app-root').appendChild(el);
        }
        
        // Render View
        el.innerHTML = this.routes[name](params);
        void el.offsetWidth; // Force Reflow
        el.classList.add('active');
        
        // Dock Management
        const dock = document.getElementById('main-dock');
        if(['home', 'search', 'profile'].includes(name)) dock.classList.remove('hidden');
        else dock.classList.add('hidden');

        // Update Tab State
        document.querySelectorAll('.dock-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.target === name);
        });
    }
    
    back() {
        if(this.history.length > 1) {
            this.history.pop();
            this.go(this.history[this.history.length - 1]);
        } else {
            this.go('home');
        }
    }
}

/* * ----------------------------------------------------------------------------
 * MODULE 5: VIEW RENDERERS
 * ----------------------------------------------------------------------------
 */
const Views = {
    /**
     * HOME VIEW
     * Displays subjects/tables list.
     */
    Home: () => {
        const data = Engine.cache;
        const subjects = data.subjects || [];
        
        return `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>My Tables</h1>
                <div onclick="App.router.go('settings')" style="cursor:pointer; padding:10px; background:var(--c-surface); border-radius:50%; border:1px solid rgba(255,255,255,0.1)">
                   ${ICONS.settings.replace('width="24"', 'width="20"')}
                </div>
            </div>
            
            ${Engine.mode === 'guest' ? 
                `<div class="card" style="background:rgba(255, 193, 7, 0.15); border-color:rgba(255, 193, 7, 0.3);">
                    <div style="display:flex; gap:10px; align-items:center; color:#ffd54f">
                        <svg style="width:20px; fill:currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                        <b>Guest Mode</b>
                    </div>
                    <p style="margin-top:5px; font-size:14px; opacity:0.9">Your data won't save across devices so sign in or log in.</p>
                </div>` : ''
            }

            <div class="list-anim">
            ${subjects.length === 0 ? `
                <div class="card" style="text-align:center; padding:40px; border-style:dashed; opacity:0.6">
                    <h3>No Tables Yet</h3>
                    <p>Create your first study table below.</p>
                </div>` : subjects.map((sub, idx) => `
                <div class="card interactive" onclick="App.router.go('detail', ${idx})">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span class="subtext">TABLE</span>
                            <h2>${sub.name}</h2>
                            <p>${(sub.tasks || []).length} Goals Pending</p>
                        </div>
                        <div style="width:40px; height:40px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center;">➜</div>
                    </div>
                    <div style="margin-top:15px; height:4px; background:rgba(0,0,0,0.3); border-radius:2px; overflow:hidden;">
                        <div style="width:${Math.random() * 100}%; height:100%; background:var(--c-primary);"></div>
                    </div>
                </div>
            `).join('')}
            </div>
            <button class="btn btn-primary" onclick="Modals.open('addSubject')">
                <svg style="width:20px; fill:white" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Create New Table
            </button>
        `;
    },

    /**
     * DETAIL VIEW
     * Displays tasks within a subject.
     */
    Detail: (idx) => {
        const sub = Engine.cache.subjects[idx];
        const tasks = sub.tasks || [];
        return `
            <div class="back-nav" onclick="App.router.back()">${ICONS.back} Back</div>
            <span class="subtext">MANAGING</span>
            <h1>${sub.name}</h1>
            <div class="list-anim" style="margin-top:20px;">
                ${tasks.length === 0 ? '<p style="text-align:center; margin:40px 0; opacity:0.5">No goals defined yet.</p>' : 
                  tasks.map(t => `<div class="card" style="padding:16px;"><b>${t.desc}</b><div style="font-size:13px; color:var(--c-primary);">Due: ${t.date}</div></div>`).join('')
                }
            </div>
            <button class="btn btn-primary" onclick="Modals.open('addTask', ${idx})">Add Goal</button>
            <div style="height:100px;"></div>
        `;
    },

    /**
     * PROFILE VIEW
     * Displays user stats and auth status.
     */
    Profile: () => {
        const d = Engine.cache;
        return `
            <div class="profile-hero">
                <div class="profile-banner" onclick="App.triggerUpload('bnr')"><img src="${d.bnr || CONFIG.assets.defBanner}"></div>
                <div class="profile-avatar" onclick="App.triggerUpload('pfp')"><img src="${d.pfp || (CONFIG.assets.defPfp + (d.user||'G'))}"></div>
            </div>
            <div class="profile-meta">
                <h1>${d.user || 'Guest User'}</h1>
                <span class="subtext" style="color:var(--c-primary)">${Engine.mode === 'cloud' ? 'CLOUD SYNC ACTIVE' : 'LOCAL DEVICE STORAGE'}</span>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:24px;">
                    <div class="card" style="text-align:center; padding:15px;"><h1>${(d.subjects||[]).length}</h1><span class="subtext">TABLES</span></div>
                    <div class="card" style="text-align:center; padding:15px;"><h1>${(d.family||[]).length}</h1><span class="subtext">FAMILY</span></div>
                </div>
                ${Engine.mode === 'guest' ? 
                    `<div class="card" style="margin-top:20px;"><h3>Sync Data</h3><p>Sign in to save data to cloud.</p><button class="btn btn-primary" onclick="App.router.go('settings')">Sign In</button></div>` : 
                    `<button class="btn btn-danger" onclick="Engine.logout()">Log Out</button>`
                }
            </div>
        `;
    },

    /**
     * SEARCH VIEW
     * Allows cloud users to find others. Locked for guests.
     */
    Search: () => {
        const isGuest = Engine.mode === 'guest';
        return `
            <h1>Search</h1>
            <p>Find other users and view their public tables.</p>
            <div class="inp-wrap" style="margin-top:20px;">
                <input class="inp" placeholder="${isGuest ? 'Sign in to search' : 'Type username...'}" 
                       oninput="App.handleSearch(this.value)" ${isGuest ? 'disabled' : ''}>
            </div>
            
            <div id="search-results" class="list-anim">
                ${isGuest ? 
                    `<div style="text-align:center; padding:30px; opacity:0.5;">
                        <svg style="width:40px; height:40px; margin-bottom:10px; opacity:0.5;" viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM8.9 6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H8.9V6zM18 20H6V10h12v10z" fill="white"/></svg>
                        <br>Search Locked<br>Guest Mode
                    </div>` : 
                    `<div style="text-align:center; padding:30px; opacity:0.5;">Start typing...</div>`
                }
            </div>
        `;
    },

    /**
     * PUBLIC PROFILE VIEW
     * View-only mode for other users.
     */
    PublicProfile: (data) => `
        <div onclick="App.router.back()" style="position:fixed; top:20px; left:20px; z-index:50; background:rgba(0,0,0,0.6); padding:8px 16px; border-radius:20px; backdrop-filter:blur(10px); cursor:pointer; font-weight:600;">← Back</div>
        <div class="profile-hero">
            <div class="profile-banner"><img src="${data.bnr || CONFIG.assets.defBanner}"></div>
            <div class="profile-avatar"><img src="${data.pfp || CONFIG.assets.defPfp + data.user}"></div>
        </div>
        <div class="profile-meta">
            <h1>${data.user}</h1>
            <span class="subtext">PUBLIC PROFILE</span>
            
            ${Engine.mode !== 'guest' ? 
                `<button class="btn btn-primary" onclick="Chat.open('${data.user}')" style="margin-bottom:20px;">
                    ${ICONS.chat} Message
                </button>` : ''
            }

            <div class="list-anim" style="margin-top:20px;">
                ${(data.subjects || []).map(s => `<div class="card"><h3>${s.name}</h3><p>${(s.tasks||[]).length} Goals</p></div>`).join('') || '<p>No public tables.</p>'}
            </div>
        </div>
    `,
    
    /**
     * SETTINGS VIEW
     * Hub for family, account, and info.
     */
    Settings: () => {
        return `
            <div class="back-nav" onclick="App.router.go('home')">${ICONS.back} Back</div>
            <h1>Settings</h1>
            
            <div class="card interactive" onclick="App.router.go('family')">
                <div style="display:flex; gap:15px; align-items:center;">
                    <div style="color:var(--c-accent)">${ICONS.family}</div>
                    <div><h3>Family Center</h3><p>Manage invites and chats</p></div>
                </div>
            </div>

            ${Engine.mode === 'guest' ? `
                <div class="card">
                    <h3>Account Access</h3>
                    <div class="inp-wrap"><input id="auth-u" class="inp" placeholder="Username"></div>
                    <div class="inp-wrap"><input id="auth-p" class="inp" type="password" placeholder="Password"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="App.handleAuth('login')">Login</button>
                        <button class="btn" onclick="App.handleAuth('signup')">Sign Up</button>
                    </div>
                </div>
            ` : `
                <div class="card">
                    <h3>App Info</h3>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; opacity:0.7;"><span>Version</span><span>6.0 Colossus</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; opacity:0.7;"><span>User</span><span>${Engine.user}</span></div>
                </div>
            `}
        `;
    },

    /**
     * FAMILY VIEW
     * Invite management and family list with chat options.
     */
    Family: () => {
        const d = Engine.cache;
        return `
            <div class="back-nav" onclick="App.router.go('settings')">${ICONS.back} Back</div>
            <h1>Family Center</h1>
            
            ${Engine.mode === 'guest' ? `<div class="card">Sign in to add family.</div>` : `
                <div class="card">
                    <h3>Send Invite</h3>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <input id="fam-inp" class="inp" placeholder="Username">
                        <button class="btn btn-primary" style="width:auto; margin:0;" onclick="App.handleInvite()">Send</button>
                    </div>
                </div>
                ${(d.invites || []).map(inv => `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b>${inv}</b>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-primary" style="height:36px; margin:0;" onclick="App.replyInvite('${inv}', true)">✓</button>
                                <button class="btn btn-danger" style="height:36px; margin:0;" onclick="App.replyInvite('${inv}', false)">✕</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
                <h3 style="margin-top:20px;">My Connections</h3>
                <div class="list-anim">
                    ${(d.family || []).length === 0 ? '<p style="opacity:0.5">No family members connected.</p>' : (d.family).map(f => `
                        <div class="card">
                            <div style="display:flex; align-items:center; justify-content:space-between;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <div style="width:10px; height:10px; background:var(--c-success); border-radius:50%;"></div>
                                    <b>${f}</b>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn btn-sm" onclick="App.viewPublicUser('${f}')">Profile</button>
                                    <button class="btn btn-primary btn-sm" onclick="Chat.open('${f}')">Chat</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}
        `;
    }
};

/* * ----------------------------------------------------------------------------
 * MODULE 6: MAIN APP CONTROLLER
 * ----------------------------------------------------------------------------
 */
const Engine = new DataEngine();
const Chat = new ChatManager();

const App = {
    router: new Router(),
    uploadType: null,
    
    /**
     * Initialization Sequence
     */
    init: () => {
        // 1. Register Routes
        App.router.register('home', Views.Home);
        App.router.register('detail', Views.Detail);
        App.router.register('profile', Views.Profile);
        App.router.register('search', Views.Search);
        App.router.register('public', Views.PublicProfile);
        App.router.register('settings', Views.Settings);
        App.router.register('family', Views.Family);

        // 2. Build Dock
        const dock = document.getElementById('main-dock');
        dock.innerHTML = `
            <div class="dock-btn" data-target="home" onclick="App.router.go('home')">${ICONS.home}</div>
            <div class="dock-btn" data-target="search" onclick="App.router.go('search')">${ICONS.search}</div>
            <div class="dock-btn" data-target="profile" onclick="App.router.go('profile')">${ICONS.profile}</div>
        `;

        // 3. Intro Animation Management
        setTimeout(() => {
            const intro = document.getElementById('intro-layer');
            intro.style.opacity = '0';
            setTimeout(() => { intro.style.display = 'none'; }, 800);
        }, 2200);

        // 4. Start App
        App.render();
        App.router.go('home');
        
        // 5. File Upload Listeners
        document.getElementById('file-helper').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    Engine.save(App.uploadType, evt.target.result);
                    App.toast("Image Updated");
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
    },

    /**
     * Core Render Loop
     */
    render: () => { 
        if(App.router.current) App.router.go(App.router.current); 
    },

    /**
     * Toast Notification System
     */
    toast: (msg) => {
        const z = document.getElementById('toast-zone');
        const el = document.createElement('div');
        el.className = 'toast';
        el.innerText = msg;
        z.appendChild(el);
        setTimeout(() => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(-20px)';
            setTimeout(() => el.remove(), 300);
        }, 3000);
    },

    /* --- AUTH HANDLERS --- */
    
    handleAuth: async (type) => {
        const u = document.getElementById('auth-u').value;
        const p = document.getElementById('auth-p').value;
        if(!u || !p) return App.toast("Missing credentials");
        try {
            if(type === 'login') await Engine.login(u, p);
            else await Engine.signup(u, p);
            App.toast(`Welcome ${u}`);
            App.router.go('home');
        } catch(e) { App.toast(e.message); }
    },
    
    /* --- SEARCH HANDLERS --- */

    handleSearch: async (val) => {
        if(!val) return;
        const container = document.getElementById('search-results');
        try {
            const res = await Engine.searchUsers(val);
            if(res.length === 0) {
                container.innerHTML = `<p style="text-align:center; padding:20px;">No results found.</p>`;
            } else {
                container.innerHTML = res.map(u => `
                    <div class="card interactive" onclick="App.viewPublicUser('${u.user}')">
                        <div style="display:flex; gap:12px; align-items:center;">
                            <img src="${u.pfp || CONFIG.assets.defPfp + u.user}" style="width:40px; height:40px; border-radius:12px; object-fit:cover;">
                            <div><b>${u.user}</b><div class="subtext">${(u.subjects||[]).length} Tables</div></div>
                        </div>
                    </div>
                `).join('');
            }
        } catch(e) { console.error(e); }
    },
    
    viewPublicUser: async (username) => {
        const data = await Engine.getPublicProfile(username);
        if(data) App.router.go('public', data);
    },

    /* --- PROFILE ACTIONS --- */

    triggerUpload: (type) => {
        if(Engine.mode === 'guest') return App.toast("Sign in to customize profile");
        App.uploadType = type;
        document.getElementById('file-helper').click();
    },

    /* --- INVITE HANDLERS --- */

    handleInvite: async () => {
        const target = document.getElementById('fam-inp').value;
        try {
            await Engine.sendInvite(target);
            App.toast("Invite Sent");
            document.getElementById('fam-inp').value = '';
        } catch(e) { App.toast(e.message); }
    },
    
    replyInvite: async (sender, accept) => {
        const d = Engine.cache;
        d.invites = d.invites.filter(i => i !== sender);
        if(accept) {
            d.family = d.family || [];
            d.family.push(sender);
            
            // Client-side hack to update sender's list (in a real app, use Cloud Functions)
            firebase.database().ref('users/'+sender+'/family').once('value', s => {
                let f = s.val() || [];
                if(!f.includes(Engine.user)) { f.push(Engine.user); s.ref.set(f); }
            });
        }
        Engine.save('root', d);
        App.render();
    }
};

/* * ----------------------------------------------------------------------------
 * MODULE 7: MODAL SYSTEM
 * ----------------------------------------------------------------------------
 */
const Modals = {
    open: (type, payload) => {
        const m = document.getElementById('modal-base');
        const t = document.getElementById('m-title');
        const b = document.getElementById('m-body');
        const btn = document.getElementById('m-btn-p');
        
        // Reset
        btn.onclick = null;
        m.classList.add('open');
        
        if(type === 'guestLock') {
            t.innerText = "Restricted Access";
            b.innerHTML = `<p>This feature requires a cloud account. Please sign in to continue.</p>`;
            btn.innerText = "Go to Login";
            btn.onclick = () => {
                Modals.close();
                App.router.go('settings');
            };
        } else if(type === 'addSubject') {
            t.innerText = "New Table";
            b.innerHTML = `<div class="inp-wrap"><label class="subtext">NAME</label><input id="m-inp-1" class="inp" placeholder="e.g. Physics"></div>`;
            btn.onclick = () => {
                const val = document.getElementById('m-inp-1').value;
                if(val) {
                    const subs = Engine.cache.subjects || [];
                    subs.push({ name: val, tasks: [] });
                    Engine.save('subjects', subs);
                    Modals.close();
                }
            };
        } else if (type === 'addTask') {
            t.innerText = "New Goal";
            b.innerHTML = `
                <div class="inp-wrap"><label class="subtext">DESCRIPTION</label><input id="m-inp-1" class="inp" placeholder="Read Chapter 1"></div>
                <div class="inp-wrap"><label class="subtext">DUE DATE</label><input id="m-inp-2" class="inp" type="date"></div>
            `;
            btn.onclick = () => {
                const desc = document.getElementById('m-inp-1').value;
                const date = document.getElementById('m-inp-2').value;
                if(desc && date) {
                    const subs = Engine.cache.subjects;
                    subs[payload].tasks.push({ desc, date });
                    Engine.save('subjects', subs);
                    Modals.close();
                    App.router.go('detail', payload);
                }
            };
        }
        
        document.getElementById('m-btn-s').onclick = Modals.close;
    },
    close: () => document.getElementById('modal-base').classList.remove('open')
};

// Bootstrap
window.onload = App.init;

</script>
</body>
</html>
